{{!-- Uploads.hbs --}}
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Profile</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="css/main-styles.css" rel="stylesheet" type="text/css" />
  <link href="css/user-styles.css" rel="stylesheet" type="text/css" />
  <link href="css/user-header-footer-styles.css" rel="stylesheet" type="text/css" />
  <link href="css/upload-styles.css" rel="stylesheet" type="text/css" />
</head>

<body class="user-body">

  <div id="loadingOverlay" class="loader-overlay">
    <div class="loader-container">
      <div class="loader-spinner"></div>
      <div class="loader-text1">Processing your documents...</div>
      <div id="documentStatus" class="loader-text2"></div>
      <div id="processingStatus" class="loader-text2"></div>

      <!-- Add progress bar -->
      <div class="progress-container">
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text">0%</div>
      </div>

      <div class="loader-subtext">This may take a few minutes depending on your file size</div>
    </div>
  </div>

  {{> mobileUserHeader}}

  <div class="sidebar">
    <div class="sidebar-logo-wrapper">
      <a href="/" class="sidebar-logo-link">
        <img src="images/logo2.png" loading="lazy" alt="Logo" class="sidebar-logo"></a>
    </div>
    <div class="nav-divider-basics nav-divider-top"></div>
    <a id="Profile" href="/profile" class="page-link w-inline-block">
      <img loading="lazy" src="images/user.svg" alt="Icon" class="nav-icon">
      <div class="page-link-text-block"><span class="page-link-text-span">Profile</span></div>
    </a>
    <a id="Upload" href="/upload" class="page-link w-inline-block w--current">
      <img src="images/file-text.svg" loading="lazy" alt="Icon" class="nav-icon">
      <div class="page-link-text-block"><span class="page-link-text-span">Upload</span></div>
    </a>
    <a id="Reports" href="/reports" aria-current="page" class="page-link w-inline-block"><img src="images/clipboard.svg"
        loading="lazy" alt="Icon" class="nav-icon">
      <div class="page-link-text-block"><span class="page-link-text-span">Reports</span></div>
    </a>
    <a id="Insights" href="/insights" class="page-link w-inline-block">
      <img src="images/layout.svg" loading="lazy" alt="Icon" class="nav-icon">
      <div class="page-link-text-block"><span class="page-link-text-span">Insights</span></div>
    </a>
    <div class="nav-divider-basics nav-divider-bottom"></div>
    <a href="/how-it-works" class="page-link w-inline-block"><img src="images/help-circle.svg" loading="lazy" alt="Icon"
        class="nav-icon">
      <div class="page-link-text-block"><span class="page-link-text-span">Help</span></div>
    </a>
    <a id="Log-out" href="/" class="page-link w-inline-block"><img src="images/unlock.svg" loading="lazy" alt="Icon"
        class="nav-icon">
      <div class="page-link-text-block"><span class="page-link-text-span">Log out</span></div>
    </a>
    <div class="sidebar-bottom-spacer"></div>
  </div>

  <section class="demo-header">
    <div class="header-container-2">
      <div>
        <h2 class="heading2">Upload Your Data</h2>
        <h3 class="subheading"></h3>
        <div class="subheading-2">Please upload as much of your medical history as possible and/or manually input your data</div>
        <div class="spacer-block"></div>
      </div>
      <!-- OCR Status Notification -->
      {{!-- <div class="ocr-status-notification">
        <div class="notification-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <div class="notification-content">
          <div class="notification-title">OCR Processing Temporarily Unavailable</div>
          <div class="notification-message">
            Our automated data extraction is currently disabled in the production environment. 
            We're working to restore full OCR functionality soon.
          </div>
        </div>
        <button class="notification-dismiss" aria-label="Dismiss notification">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div> --}}
    </div>

  </section>

  <div class="dashboard-content">
    <div class="dashboard-container">

    <div class="w-layout-grid main-grid">
      <div data-duration-in="300" data-duration-out="100" data-current="All projects" data-easing="ease"
        class="tabs w-tabs">
        <div class="in-page-menu w-tab-menu">
          <a data-w-tab="Uploads" class="in-page-link w-inline-block w-tab-link w--current">
            <div class="text-block">Upload Files</div>
          </a>
          <a data-w-tab="Output" class="in-page-link w-inline-block w-tab-link">
            <div class="text-block">File Output</div>
          </a>
        </div>

        <div class="labs-content w-tab-content">

          <!-- File Details Edit Modal -->
          <div id="fileDetailsEditModal" class="biomarker-modal">
            <div class="biomarker-modal-content">
              <div class="biomarker-modal-header">
                <h2>Edit File Details</h2>
                <span class="close-modal">&times;</span>
              </div>
              <div class="biomarker-modal-body">
                <form id="fileDetailsEditForm">
                  <input type="hidden" id="editFileId">
                  <div class="form-group">
                    <label for="editFileName">File Name:</label>
                    <input type="text" id="editFileName" required>
                  </div>
                  <div class="form-group">
                    <label for="editUploadDate">Upload Date:</label>
                    <input type="datetime-local" id="editUploadDate" required>
                  </div>
                  <div class="form-group">
                    <label for="editTestDate">Test Date:</label>
                    <input type="datetime-local" id="editTestDate" required>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="save-btn">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div data-w-tab="Uploads" class="tab-pane-basic-info w-tab-pane w--tab-active">
            <div class="dropdown-wrapper user-content-bg">
              <div class="div-block-9">
                <div class="flex">
                  <div class="upload-page-text-1">HealthLync extracts data from your bloodwork/lab files automatically
                  </div>
                  <button class="info-button" aria-label="Show important upload file details">
                    {{> svg/info}}
                  </button>
                </div>
                {{!-- Upload container --}}
                <div class="upload-section-container">
                  <div class="file-upload-container">
                    <div class="file-upload-area" id="dropZone">
                      <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" class="file-input" />
                      <div class="upload-content">
                        <div class="upload-text">Drag and drop files here</div>
                        <button class="browse-button">Browse files</button>
                        {{> svg/upload }}
                        <div class="file-limits">Limit 200MB per file • PDF, JPEG, PNG</div>
                      </div>
                    </div>
                    <div id="fileList" class="file-list"></div>
                    <button id="processFiles" class="process-button" disabled>Upload File(s)</button>
                  </div>
                  <div class="sample-pdf-section">
                    <h4>Try with our sample reports</h4>
                    <div class="sample-pdf-preview">
                      <img src="/images/sample-report-preview.png" alt="Sample medical report preview">
                      <button class="use-sample-btn" data-sample-file="/samples/jane-smith-lab-report.pdf">
                        Use Sample Reports (2 files)
                      </button>
                    </div>
                    <p style="font-size: 0.6rem; color: #64748b; text-align: center; margin-top: 0.5rem; margin-bottom: 0;">
                      Loads two Jane Smith lab reports from different dates to demonstrate trend tracking
                    </p>
                  </div>
                </div>
                <div class="upload-page-text-container">
                  {{!-- <div class="upload-page-text2">Supported file types:
                    <li>PDFs</li>
                    <li>Photos &amp; Images (JPEG
                      and PNG)</li>... More to come
                  </div> --}}
                </div>
                {{!-- <div class="upload-page-text">Once your data is uploaded successfully, pop on over to the File
                  Output
                  tab above to double-check your uploaded data.
                </div> --}}
                <div class="upload-page-text-2">Uploaded documents:</div>
                <div class="file-list-header">
                  <div class="file-list-title">Name</div>
                  <div class="file-list-title">Test/Collection Date</div>
                  <div class="file-list-title">Uploaded</div>
                  <div class="file-list-title checkbox-header">
                    <input type="checkbox" id="selectAllFiles" class="select-all-checkbox" aria-label="Select all files">
                  </div>
                  <div class="file-list-title">Actions</div>
                </div>
                <div class="uploaded-documents-list">
                  {{#if user.files}}
                  {{#each user.files}}
                  <div class="file-list-row">
                    <div class="file-name">
                      <a href="/uploads/{{this.filename}}" target="_blank">{{this.originalName}}</a>
                    </div>
                    <div class="file-date">{{formatDate this.testDate}}</div>
                    <div class="file-uploaded">{{formatDate this.uploadDate}}</div>
                    <div class="file-checkbox-container">
                      <input type="checkbox" class="file-checkbox" data-file-id="{{this._id}}" aria-label="Select file">
                    </div>
                    <div class="file-actions">
                      <button class="edit-file-btn" onclick="showFileDetailsEdit('{{this._id}}','{{this.originalName}}','{{formatDateString this.uploadDate}}','{{formatDateString this.testDate}}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                      </button>
                      <button class="delete-file-btn" data-file-id="{{this._id}}">
                        <span class="delete-icon">×</span>
                      </button>
                    </div>
                  </div>
                  {{/each}}
                  {{else}}
                  <div class="no-files-message">No documents uploaded yet</div>
                  {{/if}}
                </div>
                {{#if user.files}}
                <div class="bulk-actions">
                  <button id="deleteSelectedFiles" class="delete-selected-btn" disabled>Delete Selected Files</button>
                </div>
                {{/if}}
              </div>
            </div>

          </div>
          <div class="table-module">
            <div class="table-content"></div>
          </div>
        </div>

        <div data-w-tab="Output" class="tab-pane-ongoing w-tab-pane">
          <div class="dropdown-wrapper user-content-bg">
            <div class="div-block-9">
              <div class="upload-page-text-1">Data from uploaded file(s):</div>

              {{#if user.files}} {{!-- Check if user has any files in mongoDB - see registerSchema --}}
              {{#each user.files}} {{!-- Loop through each files  --}}
              <div class="lab-result-card {{confidenceClass extractionMethod}}">
                
                <div class="lab-result-header">
                  <div class="lab-result-header-left">
                    <h5>{{originalName}}</h5>
                    <div class="file-dates">
                      <div class="lab-result-date">
                        <span>Uploaded: {{formatDate uploadDate}}</span>
                        <span>Test Date: {{formatDate testDate}}</span>
                      </div>
                      <button class="edit-file-btn"
                        onclick="event.stopPropagation(); showFileDetailsEdit('{{_id}}', '{{originalName}}', '{{uploadDate}}', '{{testDate}}')">
                        <span class="edit-icon2">✎</span>
                      </button>
                    </div>
                  </div>
                  <div class="dropdown-indicator"></div>
                </div>

                {{#if labValues}}
                <div class="lab-values">
                  {{#each labValues as |value testName|}}
                  <div class="lab-value {{confidenceClass value.confidence}}" data-file-id="{{../this._id}}"
                    data-biomarker="{{testName}}" data-value="{{value.value}}" data-unit="{{value.unit}}"
                    data-range="{{value.referenceRange}}">
                    <div class="lab-value-content">
                      <span class="test-name">{{testName}}:</span><br>
                      <span class="test-value">{{formatNumber value.value 2}} {{value.unit}}</span><br>
                      {{#if value.referenceRange}}
                      <span class="reference-range">(Range: {{value.referenceRange}})</span>
                      {{/if}}
                    </div>
                    <div class="button-container-2">
                      <button class="edit-biomarker-btn"
                        onclick="showBiomarkerEdit('{{testName}}', '{{value.value}}', '{{value.unit}}', '{{value.referenceRange}}', '{{../this._id}}')">
                        <div class="edit-btn-content">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                          </svg>
                          <span class="edit-btn-text">Edit</span>
                        </div>
                      </button>
                      <button class="delete-biomarker-btn" onclick="deleteBiomarker('{{../this._id}}', '{{@key}}')">
                        <div class="delete-btn-content">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                              d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                          </svg>
                          <span class="delete-btn-text">Delete</span>
                        </div>
                      </button>
                    </div>
                  </div>
                  {{/each}}
                </div>
                {{else}}
                <p class="no-values">No lab values detected</p>
                {{/if}}

                {{#if processingErrors}}
                <div class="processing-errors">
                  {{#each processingErrors}}
                  <p class="error">{{this}}</p>
                  {{/each}}
                </div>
                {{/if}}
              </div>
              {{/each}}
              {{else}}
              <div class="no-files-message">No documents uploaded yet</div>
              {{/if}}


              <!-- Details Modal -->
              <div id="biomarkerDetailsModal" class="biomarker-modal">
                <div class="biomarker-modal-content">
                  <div class="biomarker-modal-header">
                    <h2 id="biomarkerDetailsTitle"></h2>
                    <span class="close-modal">&times;</span>
                  </div>
                  <div class="biomarker-modal-body">
                    <div class="biomarker-details">
                      <div class="biomarker-info">
                        <h3>Current Value</h3>
                        <p id="biomarkerValue"></p>
                      </div>
                      <div class="biomarker-source">
                        <h3>Source Document</h3>
                        <p id="biomarkerSource"></p>
                        <div id="sourceImageContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Lab Values Edit Modal -->
              <div id="biomarkerEditModal" class="biomarker-modal">
                <div class="biomarker-modal-content">
                  <div class="biomarker-modal-header">
                    <h2 id="biomarkerEditTitle"></h2>
                    <span class="close-modal">&times;</span>
                  </div>
                  <div class="biomarker-modal-subtitle">
                    Our automated scanner may occasionally need your help to ensure accuracy. Please verify this
                    value
                    and make any necessary corrections.
                  </div>
                  <div class="biomarker-modal-body">
                    <form id="biomarkerEditForm">
                      <input type="hidden" id="editFileId">
                      <input type="hidden" id="editBiomarkerName">
                      <div class="form-group">
                        <label for="editValue">Value:</label>
                        <input type="number" id="editValue" required step="any">
                      </div>
                      <div class="form-group">
                        <label for="editUnit">Unit:</label>
                        <input type="text" id="editUnit" required>
                      </div>
                      <div class="form-group">
                        <label for="editRange">Reference Range:</label>
                        <input type="text" id="editRange">
                      </div>
                      <div class="form-actions">
                        <button type="submit" class="save-btn">Save Changes</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="upload-page-text-1"><br>‍<br><br><br><br>
        <br>‍<br>
      </div>
    </div>
  </div>

  <!-- Update the modal div to have these changes -->
  <div id="simpleInfoModal" class="simple-info-modal">
    <div style="position: absolute; top: 0; left: -160px; width: 160px; height: 100%; background: transparent;"></div>
    <div style="position: relative; background-color: white; margin: 40px auto; max-width: 700px; width: 90%; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); overflow: hidden;">
      <!-- Header section -->
      <div style="display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e5e7eb;">
        <button id="simpleModalBackButton" style="background: none; border: none; cursor: pointer; margin-right: 10px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Upload Information</h2>
        <button id="simpleModalCloseX" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 20px; line-height: 1;">×</button>
      </div>
      
      <!-- Content section -->
      <div style="padding: 20px; max-height: 70vh; overflow-y: auto; font-size: 14px;">
        <p style="margin-top: 0; margin-bottom: 0.5rem; color: #374151;">For the best results when extracting data from your medical documents:</p>
        <ul style="padding-left: 24px; color: #374151;">
          <li style="margin-bottom: 8px;"><strong>PDF files are preferred</strong> - They generally provide the highest quality text data for our system to process.</li>
          <li style="margin-bottom: 8px;"><strong>Avoid low-resolution images</strong> - Blurry or low-quality photos will significantly reduce extraction accuracy.</li>
          <li style="margin-bottom: 8px;"><strong>Ensure documents are well-lit and flat</strong> - If taking photos, use good lighting and avoid shadows or glare.</li>
          <li style="margin-bottom: 8px;"><strong>Include the entire document</strong> - Make sure lab value tables and reference ranges are fully visible.</li>
          <li style="margin-bottom: 8px;"><strong>Check your results</strong> - After upload, review the extracted data in the File Output tab to verify accuracy.</li>
        </ul>
        <p style="margin-bottom: 0; color: #374151;">Our optical character recognition (OCR) system works best with clear, high-resolution documents in PDF format.</p>
      </div>
      
      <!-- Footer section -->
      <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; text-align: right;">
        <button id="simpleModalCloseButton" style="padding: 8px 16px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Close</button>
      </div>
    </div>
  </div>

  <script
    src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6606de22e8c152e6b19be98a"
    type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>
  <script src="js/main.js" type="text/javascript"></script>
  <script src="js/main-user.js" defer type="module"></script>
  <script> // File Uploader - Works for both Local and Production
    document.addEventListener('DOMContentLoaded', function () {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const fileList = document.getElementById('fileList');
      const processButton = document.getElementById('processFiles');
      const files = new Set();

      // Detect environment - check if we're running locally or in production
      const isLocalEnvironment = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1' || 
                                window.location.hostname.includes('localhost');

      console.log(`Environment detected: ${isLocalEnvironment ? 'Local' : 'Production'}`);

      // Define the loading functions
      function showLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      // Update progress bar
      function updateProgress(percentage, statusText, documentText) {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusDiv = document.getElementById('processingStatus');
        const documentDiv = document.getElementById('documentStatus');

        if (progressFill) {
          progressFill.style.width = percentage + '%';
        }
        if (progressText) {
          progressText.textContent = Math.round(percentage) + '%';
        }
        if (statusDiv && statusText) {
          statusDiv.textContent = statusText;
        }
        if (documentDiv && documentText) {
          documentDiv.textContent = documentText;
        }
      }

      // Success overlay functions
      function showSuccessOverlay(title, message, details = '') {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          // Change the overlay content to show success
          const container = overlay.querySelector('.loader-container');
          if (container) {
            container.innerHTML = `
              <div class="success-icon">✅</div>
              <div class="success-title">${title}</div>
              <div class="success-message">${message}</div>
              ${details ? `<div class="success-details">${details}</div>` : ''}
              <button id="successContinueBtn" class="success-close-btn">Continue</button>
            `;
            
            // Add event listener to the continue button immediately after creating it
            const continueBtn = container.querySelector('#successContinueBtn');
            if (continueBtn) {
              continueBtn.addEventListener('click', hideSuccessOverlay);
              console.log('Continue button event listener added'); // Debug log
            }
          }
          overlay.style.display = 'flex';
        }
      }

      function hideSuccessOverlay() {
        console.log('hideSuccessOverlay called'); // Debug log
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'none';
          
          // Reset to original loader content for next time
          const container = overlay.querySelector('.loader-container');
          if (container) {
            container.innerHTML = `
              <div class="loader-spinner"></div>
              <div class="loader-text1">Processing your documents...</div>
              <div id="documentStatus" class="loader-text2"></div>
              <div id="processingStatus" class="loader-text2"></div>
              <div class="progress-container">
                <div class="progress-bar">
                  <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">0%</div>
              </div>
              <div class="loader-subtext">This may take a few minutes depending on your file size</div>
            `;
          }
          
          // Cleanup and reload
          files.clear();
          fileList.innerHTML = '';
          updateProcessButton();
          setTimeout(() => {
            window.location.reload();
          }, 500);
        }
      }
      
      window.hideSuccessOverlay = hideSuccessOverlay;
      
      // Local environment progress tracking (with WebSocket)
      function setupLocalProgressTracking() {
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const ws = new WebSocket(`${protocol}//${window.location.host}`);

          let currentDocument = 1;
          let totalDocuments = files.size;
          let estimatedProgress = 0;
          let progressInterval;
          let processingCompleted = false;
          let extractionCompleted = false;

          const statusDiv = document.getElementById('processingStatus');
          const documentDiv = document.getElementById('documentStatus');
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');

          ws.onopen = () => {
            console.log('WebSocket connected for local processing');
          };

          ws.onmessage = function (event) {
            const message = event.data;
            console.log('WebSocket message:', message);

            // Handle document processing messages
            if (message.includes('Processing file')) {
              const match = message.match(/Processing file (\d+) of (\d+)/);
              if (match && documentDiv) {
                currentDocument = parseInt(match[1]);
                totalDocuments = parseInt(match[2]);
                documentDiv.textContent = `Processing document ${currentDocument} of ${totalDocuments}`;
                
                if (statusDiv) {
                  statusDiv.textContent = 'Preparing document for OCR...';
                }
                
                clearInterval(progressInterval);
                estimatedProgress = 0;
                processingCompleted = false;
                extractionCompleted = false;
                if (progressFill) {
                  progressFill.style.width = '0%';
                  progressText.textContent = '0%';
                }
              }
            }
            // Handle OCR initialization
            else if (message.includes('Running command:')) {
              if (statusDiv) {
                statusDiv.textContent = 'Initializing OCR engine...';
              }
              
              estimatedProgress = 1;
              if (progressFill) {
                progressFill.style.width = '1%';
                progressText.textContent = '1%';
              }
              
              clearInterval(progressInterval);
              progressInterval = setInterval(() => {
                if (!processingCompleted && estimatedProgress < 99) {
                  estimatedProgress += 1;
                  if (progressFill) {
                    progressFill.style.width = estimatedProgress + '%';
                    progressText.textContent = Math.round(estimatedProgress) + '%';
                  }
                }
              }, 500);
            }
            // Handle page processing
            else if (message.includes('Processing page')) {
              const match = message.match(/Processing page (\d+) of (\d+)/);
              if (match && statusDiv) {
                const currentPage = parseInt(match[1]);
                const totalPagesFromMessage = parseInt(match[2]);
                const isEstimated = message.includes('(estimated)');
                
                statusDiv.textContent = `Processing page ${currentPage} of ${totalPagesFromMessage}${isEstimated ? ' (estimated)' : ''}`;
                
                if (!isEstimated && estimatedProgress < 75) {
                  clearInterval(progressInterval);
                  progressInterval = setInterval(() => {
                    if (!processingCompleted && estimatedProgress < 90) {
                      estimatedProgress += 2;
                      if (progressFill) {
                        progressFill.style.width = estimatedProgress + '%';
                        progressText.textContent = Math.round(estimatedProgress) + '%';
                      }
                    }
                  }, 400);
                }
              }
            }
            // Handle completion
            else if (message.includes('Completed processing')) {
              processingCompleted = true;
              clearInterval(progressInterval);
              if (statusDiv) {
                statusDiv.textContent = 'Extracting data and finalizing...';
              }
              
              const finalizeInterval = setInterval(() => {
                if (estimatedProgress < 95) {
                  estimatedProgress = Math.min(estimatedProgress + 3, 95);
                  if (progressFill) {
                    progressFill.style.width = estimatedProgress + '%';
                    progressText.textContent = Math.round(estimatedProgress) + '%';
                  }
                } else {
                  clearInterval(finalizeInterval);
                }
              }, 333);
            }
            // Handle extraction completion
            else if (message.includes('Found lab values:')) {
              extractionCompleted = true;
              if (statusDiv) {
                statusDiv.textContent = 'Finalizing...';
              }
              
              const completeInterval = setInterval(() => {
                if (estimatedProgress < 99) {
                  estimatedProgress = Math.min(estimatedProgress + 5, 99);
                  if (progressFill) {
                    progressFill.style.width = estimatedProgress + '%';
                    progressText.textContent = Math.round(estimatedProgress) + '%';
                  }
                } else {
                  clearInterval(completeInterval);
                }
              }, 200);
            }
          };

          ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            clearInterval(progressInterval);
          };

          return ws;
        } catch (error) {
          console.error('Failed to setup WebSocket:', error);
          return null;
        }
      }

      // Production environment progress simulation
      function simulateProductionProgress(totalFiles, currentFileIndex, callback) {
        let progress = 0;
        const startProgress = (currentFileIndex / totalFiles) * 100;
        const endProgress = ((currentFileIndex + 1) / totalFiles) * 100;
        
        // Cap the end progress at 99% for the final file
        const cappedEndProgress = currentFileIndex === totalFiles - 1 ? 
          Math.min(endProgress, 99) : endProgress;
        
        const progressRange = cappedEndProgress - startProgress;

        const interval = setInterval(() => {
          progress += 1; // Increase by 1% every 500ms
          const currentProgress = startProgress + (progress / 100) * progressRange;
          
          if (progress < 95) {
            updateProgress(
              currentProgress,
              `Processing file ${currentFileIndex + 1} of ${totalFiles}...`,
              `Extracting data using external OCR service...`
            );
          } else {
            clearInterval(interval);
            updateProgress(
              cappedEndProgress,
              `File ${currentFileIndex + 1} processing complete`,
              `OCR extraction finished`
            );
            if (callback) callback();
          }
        }, 500);

        return interval;
      }

      // Handle click on browse button
      document.querySelector('.browse-button').addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
      });

      // Handle drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#518458'; // Changed from blue to green
        dropZone.style.backgroundColor = '#f2f9f1'; // Changed from blue to green
      });

      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#518458'; // Keep consistent green
        dropZone.style.backgroundColor = '#f2f9f1'; // Keep consistent green background
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#518458'; // Keep green
        dropZone.style.backgroundColor = '#f2f9f1'; // Keep green background
        handleFiles(e.dataTransfer.files);
      });

      // Handle file input change
      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      // File handler function
      function handleFiles(fileList) {
        for (const file of fileList) {
          // Different size limits based on environment
          const maxSize = isLocalEnvironment ? 200 * 1024 * 1024 : 50 * 1024 * 1024; // 200MB local, 50MB production
          const maxSizeText = isLocalEnvironment ? '200MB' : '50MB';
          
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is ${maxSizeText}.`);
            continue;
          }

          if (!['application/pdf', 'image/jpeg', 'image/png'].includes(file.type)) {
            alert(`File ${file.name} is not supported. Please upload PDF, JPEG, or PNG files.`);
            continue;
          }

          files.add(file);
          displayFile(file);
        }
        updateProcessButton();
      }

      // Display file function
      function displayFile(file) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
          <span class="file-name">${file.name}</span>
          <button class="remove-file">Remove</button>
        `;

        div.querySelector('.remove-file').addEventListener('click', () => {
          files.delete(file);
          div.remove();
          updateProcessButton();
        });

        fileList.appendChild(div);
      }

      function updateProcessButton() {
        processButton.disabled = files.size === 0;
      }

      // Handle "Use This Sample" button click
      const useSampleBtn = document.querySelector('.use-sample-btn');
      
      if (useSampleBtn) {
        useSampleBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          
          // Define both sample files
          const sampleFiles = [
            {
              path: '/samples/jane-smith-lab-report.pdf',
              name: 'jane-smith-lab-report-2025-07-28.pdf'
            },
            {
              path: '/samples/jane-smith-lab-report-follow-up.pdf',
              name: 'jane-smith-lab-report-2026-01-28.pdf'
            }
          ];
          
          try {
            // Show loading state
            const originalContent = this.innerHTML;
            this.style.opacity = '0.7';
            this.style.pointerEvents = 'none';
            this.innerHTML = '⌛ Loading samples...';
            
            // Load both files
            for (const sampleFileInfo of sampleFiles) {
              try {
                // Fetch the sample PDF file
                const response = await fetch(sampleFileInfo.path);
                
                if (!response.ok) {
                  console.warn(`Could not load ${sampleFileInfo.name}`);
                  continue; // Skip this file but continue with others
                }
                
                // Convert response to blob
                const blob = await response.blob();

                // Mobile-compatible file creation
                let sampleFile;
                try {
                  sampleFile = new File([blob], sampleFileInfo.name, {
                    type: 'application/pdf',
                    lastModified: Date.now()
                  });
                } catch (e) {
                  sampleFile = blob;
                  sampleFile.name = sampleFileInfo.name;
                  sampleFile.lastModified = Date.now();
                }
                
                // Add the sample file using your existing logic
                files.add(sampleFile);
                
                // Display the file EXACTLY like drag/drop does - matching your handleFiles function
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                // Create the exact same structure as drag/drop files
                fileItem.innerHTML = `
                  <span class="file-name">${sampleFileInfo.name}</span>
                  <span class="file-size">${(sampleFile.size / 1024 / 1024).toFixed(2)} MB</span>
                  <button class="remove-file" data-filename="${sampleFileInfo.name}">Remove</button>
                `;
                
                // Add event listener for remove button - exactly like drag/drop files
                const removeBtn = fileItem.querySelector('.remove-file');
                removeBtn.addEventListener('click', () => {
                  files.delete(sampleFile);
                  fileItem.remove();
                  updateProcessButton();
                });
                
                fileList.appendChild(fileItem);
                
              } catch (fileError) {
                console.error(`Error loading ${sampleFileInfo.name}:`, fileError);
                // Continue with next file
              }
            }
            
            // Update the process button using your existing function
            updateProcessButton();
            
            // Reset button state
            this.style.opacity = '1';
            this.style.pointerEvents = 'auto';
            this.innerHTML = originalContent;
            
            // Optional: Show visual feedback
            const sampleSection = document.querySelector('.sample-pdf-section');
            sampleSection.style.borderColor = '#699670';
            sampleSection.style.backgroundColor = '#f2f9f1';
            
            setTimeout(() => {
              sampleSection.style.borderColor = '#e2e8f0';
              sampleSection.style.backgroundColor = '#fff';
            }, 1000);
            
          } catch (error) {
            console.error('Error loading sample files:', error);
            alert('Sorry, could not load the sample files. Please try uploading your own files.');
            
            // Reset button state on error
            this.style.opacity = '1';
            this.style.pointerEvents = 'auto';
            this.innerHTML = originalContent;
          }
        });
      }

      // Main process button click handler
      processButton.addEventListener('click', async () => {
        if (isLocalEnvironment) {
          await processFilesLocal();
        } else {
          await processFilesProduction();
        }
      });

      // Local environment processing (original method with WebSocket)
      async function processFilesLocal() {
        const formData = new FormData();
        files.forEach(file => {
          formData.append('files', file);
        });

        try {
          showLoading();

          // Setup WebSocket for real-time progress
          const ws = setupLocalProgressTracking();
          let progressInterval;

          // Start the upload
          const response = await fetch('/upload-files', {
            method: 'POST',
            body: formData
          });

          // Clean up WebSocket and intervals
          if (progressInterval) {
            clearInterval(progressInterval);
          }

          if (response.ok) {
            const result = await response.json();
            if (ws) {
              ws.close();
            }
            
            // Wait for progress to complete before showing success
            setTimeout(() => {
            // Update to 100% right before showing success
            updateProgress(100, 'Complete!', 'Processing finished');
            
            setTimeout(() => {
              showSuccessOverlay('Success!', 'Files processed successfully using local OCR!'); // ← NEW LINE
              // Remove these lines since hideSuccessOverlay() handles them:
              // files.clear();
              // fileList.innerHTML = '';
              // updateProcessButton();
              // setTimeout(() => {
              //   window.location.reload();
              // }, 500);
            }, 300);
          }, 1500);
            
          } else {
            throw new Error('Upload failed');
          }
        } catch (error) {
          console.error('Local upload error:', error);
          alert('Error processing files: ' + error.message);
        } finally {
          hideLoading();
        }
      }

      // Production environment processing (external OCR service)
      async function processFilesProduction() {
        const formData = new FormData();
        const filesArray = Array.from(files);
        
        filesArray.forEach(file => {
          formData.append('files', file);
        });

        try {
          showLoading();
          
          // Initialize progress
          updateProgress(0, 'Starting upload...', `Preparing ${filesArray.length} file(s) for external OCR processing`);

          // Process files with progress simulation
          let completedFiles = 0;
          const progressPromises = [];

          // Start upload
          const uploadPromise = fetch('/upload-files', {
            method: 'POST',
            body: formData
          });

          // Simulate progress for each file
          filesArray.forEach((file, index) => {
            const progressPromise = new Promise((resolve) => {
              setTimeout(() => {
                const interval = simulateProductionProgress(filesArray.length, index, () => {
                  completedFiles++;
                  resolve();
                });
              }, index * 1000);
            });
            progressPromises.push(progressPromise);
          });

          // Wait for upload to complete
          const response = await Promise.race([
            uploadPromise,
            Promise.all(progressPromises).then(() => uploadPromise)
          ]);

          // Progress stays at 99% until final completion
          updateProgress(99, 'Almost done - finalizing...', 'All files processed using external OCR service');

          if (response.ok) {
            const result = await response.json();
            
            // Show success message with details
            let successMessage = 'Files processed successfully using external OCR service!';
            if (result.processedCount !== undefined && result.failedCount !== undefined) {
              successMessage += `\n\nProcessed: ${result.processedCount} files\nFailed: ${result.failedCount} files`;
            }
            
            // Wait a moment before showing success
            setTimeout(() => {
              // Update to 100% right before showing success
              updateProgress(100, 'Complete!', 'Processing finished');
              
              setTimeout(() => {
                const details = result.processedCount !== undefined ? 
                  `Processed: ${result.processedCount} files\nFailed: ${result.failedCount} files` : '';
                showSuccessOverlay('Success!', 'Files processed successfully using external OCR service!', details); // ← NEW LINE
                // Remove these lines since hideSuccessOverlay() handles them:
                // files.clear();
                // fileList.innerHTML = '';
                // updateProcessButton();
                // setTimeout(() => {
                //   window.location.reload();
                // }, 400);
              }, 300);
            }, 500);
            
          } else {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Upload failed');
          }
        } catch (error) {
          console.error('Production upload error:', error);
          
          let errorMessage = 'Error processing files: ' + error.message;
          if (error.message.includes('OCR service')) {
            errorMessage += '\n\nThe external OCR service may be temporarily unavailable. Please try again in a few minutes.';
          }
          
          alert(errorMessage);
        } finally {
          hideLoading();
        }
      }

      // Handle file deletions (existing code)
      document.querySelectorAll('.delete-file-btn').forEach(button => {
        button.addEventListener('click', async function () {
          if (!confirm('Are you sure you want to delete this file?')) return;

          const fileId = this.dataset.fileId;
          try {
            const response = await fetch('/delete-file', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ fileId })
            });

            if (response.ok) {
              this.closest('.file-list-row').remove();
              const filesList = document.querySelector('.uploaded-documents-list');
              if (!filesList.querySelector('.file-list-row')) {
                filesList.innerHTML = '<div class="no-files-message">No documents uploaded yet</div>';
              }
            } else {
              throw new Error('Failed to delete file');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete file: ' + error.message);
          }
        });
      });

      // Show environment info in console for debugging
      console.log(`Upload script initialized for ${isLocalEnvironment ? 'Local' : 'Production'} environment`);
      console.log(`Max file size: ${isLocalEnvironment ? '200MB' : '50MB'}`);
      console.log(`Progress tracking: ${isLocalEnvironment ? 'WebSocket (Real-time)' : 'Simulated'}`);
    });  
  </script>
  <script> // Google Vision Enhanced Progress Tracking
    document.addEventListener('DOMContentLoaded', function() {
      // Check if we're using Google Vision implementation
      const isGoogleVision = '{{ocrImplementation}}' === 'GoogleVision';
      
      if (!isGoogleVision) {
        console.log('Using PaddleOCR - Google Vision progress tracking disabled');
        return; // Exit early if not using Google Vision
      }
      
      console.log('Google Vision progress tracking enabled');
      
      // GOOGLE VISION: Enhanced WebSocket progress tracking
      function setupGoogleVisionProgressTracking() {
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const ws = new WebSocket(`${protocol}//${window.location.host}`);

          const statusDiv = document.getElementById('processingStatus');
          const documentDiv = document.getElementById('documentStatus');
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');

          ws.onopen = () => {
            console.log('WebSocket connected for Google Vision progress tracking');
          };

          ws.onmessage = function (event) {
            const message = event.data;
            console.log('Google Vision WebSocket message:', message);

            try {
              // Try to parse as JSON for structured progress updates
              const progressData = JSON.parse(message);
              
              if (progressData.type === 'progress') {
                // Handle structured progress updates from Google Vision
                if (documentDiv) {
                  documentDiv.textContent = `Processing document ${progressData.fileIndex} of ${progressData.totalFiles}`;
                }
                
                if (statusDiv) {
                  statusDiv.textContent = progressData.status;
                }
                
                if (progressFill && progressText) {
                  const progress = Math.min(progressData.progress, 99); // Cap at 99% until complete
                  progressFill.style.width = progress + '%';
                  progressText.textContent = progress + '%';
                }
                
                return;
              }
            } catch (e) {
              // Not JSON, handle as text message
            }

            // Handle text-based progress messages for Google Vision
            if (message.includes('Processing file')) {
              const match = message.match(/Processing file (\d+) of (\d+)/);
              if (match && documentDiv) {
                documentDiv.textContent = `Processing document ${match[1]} of ${match[2]}`;
                
                if (statusDiv) {
                  statusDiv.textContent = 'Initializing Google Document AI...';
                }
                
                // Reset progress for new file
                if (progressFill && progressText) {
                  progressFill.style.width = '0%';
                  progressText.textContent = '0%';
                }
              }
            }
            else if (message.includes('Document AI: Making API call')) {
              if (statusDiv) {
                statusDiv.textContent = 'Sending to Google Document AI...';
              }
              updateGoogleVisionProgress(30);
            }
            else if (message.includes('Document AI: Extracted')) {
              if (statusDiv) {
                statusDiv.textContent = 'Processing OCR results...';
              }
              updateGoogleVisionProgress(70);
            }
            else if (message.includes('Universal parser found')) {
              if (statusDiv) {
                statusDiv.textContent = 'Biomarker extraction complete';
              }
              updateGoogleVisionProgress(95);
            }
            else if (message.includes('Found') && message.includes('biomarkers')) {
              if (statusDiv) {
                statusDiv.textContent = 'Analysis complete';
              }
              updateGoogleVisionProgress(98);
            }
            else if (message.includes('Files saved successfully')) {
              if (statusDiv) {
                statusDiv.textContent = 'All files processed successfully!';
              }
              
              // Complete the progress bar
              if (progressFill && progressText) {
                progressFill.style.width = '100%';
                progressText.textContent = '100%';
              }
            }
            else if (message.includes('Error')) {
              if (statusDiv) {
                statusDiv.textContent = 'Processing error occurred';
              }
            }
          };

          ws.onerror = (error) => {
            console.error('Google Vision WebSocket error:', error);
          };

          ws.onclose = () => {
            console.log('Google Vision WebSocket connection closed');
          };

          return ws;
        } catch (error) {
          console.error('Failed to setup Google Vision WebSocket:', error);
          return null;
        }
      }

      // GOOGLE VISION: Enhanced progress update function
      function updateGoogleVisionProgress(percentage, mainText, subText) {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusDiv = document.getElementById('processingStatus');
        const documentDiv = document.getElementById('documentStatus');
        
        if (progressFill) {
          progressFill.style.width = Math.min(percentage, 100) + '%';
        }
        
        if (progressText) {
          progressText.textContent = Math.round(Math.min(percentage, 100)) + '%';
        }
        
        if (statusDiv && mainText) {
          statusDiv.textContent = mainText;
        }
        
        if (documentDiv && subText) {
          documentDiv.textContent = subText;
        }
      }

      // GOOGLE VISION: Override the existing processFilesLocal function for Google Vision
      const originalProcessButton = document.querySelector('.process-button');
      if (originalProcessButton) {
        // Remove existing event listeners and add Google Vision version
        const newProcessButton = originalProcessButton.cloneNode(true);
        originalProcessButton.parentNode.replaceChild(newProcessButton, originalProcessButton);
        
        newProcessButton.addEventListener('click', async function() {
          const files = document.querySelectorAll('.file-item');
          if (files.length === 0) {
            alert('Please select files to process');
            return;
          }
          
          // Get files from the file input or stored files
          const fileInput = document.querySelector('#fileInput');
          const formData = new FormData();
          
          // Add files to form data
          if (fileInput && fileInput.files) {
            for (let i = 0; i < fileInput.files.length; i++) {
              formData.append('files', fileInput.files[i]);
            }
          }

          try {
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
              loadingOverlay.style.display = 'flex';
            }

            // Setup Google Vision WebSocket for real-time progress
            const ws = setupGoogleVisionProgressTracking();

            // Start the upload with Google Vision progress tracking
            const response = await fetch('/upload-files', {
              method: 'POST',
              body: formData
            });

            // Clean up WebSocket
            if (ws) {
              setTimeout(() => ws.close(), 1000);
            }

            if (response.ok) {
              const result = await response.json();
              
              // Wait a moment for final progress updates
              setTimeout(() => {
                // Update to 100% right before showing success
                updateGoogleVisionProgress(100, 'Complete!', 'Processing finished');
                
                setTimeout(() => {
                  // Show success message
                  showGoogleVisionSuccess('Success!', 'Files processed successfully using Google Document AI!');
                }, 300);
              }, 1500);
              
            } else {
              throw new Error('Upload failed');
            }
          } catch (error) {
            console.error('Google Vision upload error:', error);
            alert('Error processing files: ' + error.message);
            
            // Hide loading overlay on error
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
            }
          }
        });
      }

      // GOOGLE VISION: Success overlay function
      function showGoogleVisionSuccess(title, message, details) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          const container = overlay.querySelector('.loader-container');
          if (container) {
            container.innerHTML = `
              <div class="success-icon">✅</div>
              <div class="success-title">${title}</div>
              <div class="success-message">${message}</div>
              ${details ? `<div class="success-details">${details}</div>` : ''}
              <button id="googleVisionSuccessBtn" class="success-close-btn">Continue</button>
            `;
            
            // Add event listener to the continue button
            const continueBtn = container.querySelector('#googleVisionSuccessBtn');
            if (continueBtn) {
              continueBtn.addEventListener('click', function() {
                overlay.style.display = 'none';
                
                // Reset and reload
                setTimeout(() => {
                  window.location.reload();
                }, 500);
              });
            }
          }
          overlay.style.display = 'flex';
        }
      }

      // Make functions globally accessible for debugging
      window.setupGoogleVisionProgressTracking = setupGoogleVisionProgressTracking;
      window.updateGoogleVisionProgress = updateGoogleVisionProgress;
      
      console.log('Google Vision progress tracking setup complete');
    });
  </script>
  <script> // Biomarker editor
    window.showBiomarkerDetails = function (name, value, unit, range, sourceDoc) {
      const modal = document.getElementById('biomarkerDetailsModal');
      const title = document.getElementById('biomarkerDetailsTitle');
      const valueEl = document.getElementById('biomarkerValue');
      const sourceEl = document.getElementById('biomarkerSource');

      title.textContent = name;
      valueEl.textContent = `${value} ${unit} (Reference Range: ${range})`;
      sourceEl.textContent = `Document: ${sourceDoc}`;

      modal.style.display = 'block';
    };

    window.showBiomarkerEdit = function (name, value, unit, range, fileId) {
      console.log('Edit biomarker called with:', { name, value, unit, range, fileId });
      const modal = document.getElementById('biomarkerEditModal');
      const title = document.getElementById('biomarkerEditTitle');
      const valueInput = document.getElementById('editValue');
      const unitInput = document.getElementById('editUnit');
      const rangeInput = document.getElementById('editRange');
      const fileIdInput = document.getElementById('editFileId');
      const biomarkerNameInput = document.getElementById('editBiomarkerName');

      title.textContent = `Edit ${name}`;
      valueInput.value = value;
      unitInput.value = unit;
      rangeInput.value = range;
      fileIdInput.value = fileId;
      biomarkerNameInput.value = name;

      console.log('Set fileId input value to:', fileId); // Debug log
      modal.style.display = 'block';
    };

    window.formatDateForInput = function (dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toISOString().slice(0, 16);
    };

    window.showFileDetailsEdit = function (fileId, fileName, uploadDate, testDate) {
      console.log('Edit button clicked:', { fileId, fileName, uploadDate, testDate });

      const modal = document.getElementById('fileDetailsEditModal');
      if (!modal) {
        console.error('Modal element not found!');
        return;
      }

      const fileIdInput = document.getElementById('editFileId');
      const fileNameInput = document.getElementById('editFileName');
      const uploadDateInput = document.getElementById('editUploadDate');
      const testDateInput = document.getElementById('editTestDate');

      if (!fileIdInput || !fileNameInput || !uploadDateInput || !testDateInput) {
        console.error('One or more input elements not found!');
        return;
      }

      try {
        fileIdInput.value = fileId;
        fileNameInput.value = fileName;
        uploadDateInput.value = formatDateForInput(uploadDate);
        testDateInput.value = formatDateForInput(testDate);

        console.log('Set input values:', {
          fileId: fileIdInput.value,
          fileName: fileNameInput.value,
          uploadDate: uploadDateInput.value,
          testDate: testDateInput.value
        });

        modal.style.display = 'block';
      } catch (error) {
        console.error('Error setting input values:', error);
      }
    };

    // Improved date formatting function
    function formatDateForInput(dateString) {
      if (!dateString) {
        console.warn('Empty date string received');
        return '';
      }
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
          console.warn('Invalid date string:', dateString);
          return '';
        }
        return date.toISOString().slice(0, 16);
      } catch (error) {
        console.error('Error formatting date:', error);
        return '';
      }
    }

    // Close modal if clicking outside
    window.onclick = function (event) {
      if (event.target.classList.contains('biomarker-modal')) {
        event.target.style.display = 'none';
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      // Add to your existing event listeners
      document.getElementById('fileDetailsEditForm').onsubmit = async function (e) {
        e.preventDefault();

        const fileId = document.getElementById('editFileId').value;
        const fileName = document.getElementById('editFileName').value;
        const uploadDate = document.getElementById('editUploadDate').value;
        const testDate = document.getElementById('editTestDate').value;

        try {
          const response = await fetch('/update-file-details', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fileId,
              fileName,
              uploadDate,
              testDate
            })
          });

          if (response.ok) {
            document.getElementById('fileDetailsEditModal').style.display = 'none';
            window.location.reload();
          } else {
            throw new Error('Failed to update file details');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to update file details: ' + error.message);
        }
      };
    });

    // Add deleteBiomarker to window object so it's globally accessible
    window.deleteBiomarker = async function (fileId, biomarkerName) {
      if (!confirm(`Are you sure you want to delete ${biomarkerName}?`)) {
        return;
      }

      try {
        const response = await fetch('/delete-biomarker', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            fileId,
            biomarkerName
          })
        });

        const result = await response.json();

        if (response.ok) {
          // Remove the biomarker element from the UI
          const biomarkerElement = document.querySelector(
            `.lab-value[data-file-id="${fileId}"][data-biomarker="${biomarkerName}"]`
          );
          if (biomarkerElement) {
            biomarkerElement.remove();
          }
          // Optional: show success message
          alert('Biomarker deleted successfully!');
        } else {
          throw new Error(result.message || 'Failed to delete biomarker');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete biomarker: ' + error.message);
      }
    };

    // DOM ready event listener for initialization
    document.addEventListener('DOMContentLoaded', function () {
      // Close modals
      document.querySelectorAll('.close-modal').forEach(button => {
        button.onclick = function () {
          this.closest('.biomarker-modal').style.display = 'none';
        }
      });

      // Close modal if clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains('biomarker-modal')) {
          event.target.style.display = 'none';
        }
      }

      // Handle form submission
      document.getElementById('biomarkerEditForm').onsubmit = async function (e) {
        e.preventDefault();

        // Get form values
        const fileId = document.getElementById('editFileId').value;
        const biomarkerName = document.getElementById('editBiomarkerName').value;
        const value = document.getElementById('editValue').value;
        const unit = document.getElementById('editUnit').value;
        const range = document.getElementById('editRange').value;

        // console.log('Submitting update:', { fileId, biomarkerName, value, unit, range }); // Debug log

        try {

          const response = await fetch('/update-biomarker', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fileId,
              biomarkerName,
              value,
              unit,
              referenceRange: range
            })
          });
          const result = await response.json();
          // console.log('Server response:', result); // Debug log

          if (response.ok) {
            alert('Biomarker updated successfully!');
            // Close the modal and refresh the page to show updated values
            document.getElementById('biomarkerEditModal').style.display = 'none';

            // Update the UI immediately
            const biomarkerElement = document.querySelector(
              `.lab-value[data-file-id="${fileId}"][data-biomarker="${biomarkerName}"]`
            );

            if (biomarkerElement) {
              biomarkerElement.querySelector('.test-value').textContent =
                `${parseFloat(value).toFixed(2)} ${unit}`;
              const rangeSpan = biomarkerElement.querySelector('.reference-range');
              if (rangeSpan) {
                rangeSpan.textContent = range ? `(Range: ${range})` : '';
              }
            }

            // Force a page refresh to ensure data is current
            window.location.reload();
          } else {
            throw new Error(result.message || 'Failed to update biomarker');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to update biomarker: ' + error.message);
        }
      };

      // Close the modal
      document.getElementById('biomarkerEditModal').style.display = 'none';
    });
  </script>
  <script> // Miscellaneous
    // Make toggleLabValues available globally
    window.toggleLabValues = function (header) {
      const card = header.closest('.lab-result-card');
      if (card) {
        card.classList.toggle('expanded');
        console.log('Toggled expanded class:', card.classList.contains('expanded')); // Debug log
      }
    };

    // Add event listeners after DOM loads
    document.addEventListener('DOMContentLoaded', function () {
      // Prevent edit button from triggering dropdown
      document.querySelectorAll('.edit-file-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });

      // Initialize dropdowns (if needed)
      document.querySelectorAll('.lab-result-card').forEach(card => {
        const header = card.querySelector('.lab-result-header');
        if (header) {
          header.addEventListener('click', function () {
            toggleLabValues(this);
          });
        }
      });
    });
  </script>
  <script> // Open the page on the Output tab
    document.addEventListener('DOMContentLoaded', function() {
        // Check for tab parameter in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        
        // If tab parameter exists and matches one of our tabs
        if (tabParam) {
          // Find all tab links
          const tabLinks = document.querySelectorAll('.in-page-link');
          const tabPanes = document.querySelectorAll('.w-tab-pane');
          
          // Look for the tab that matches our parameter
          tabLinks.forEach((link, index) => {
            const tabName = link.getAttribute('data-w-tab');
            
            // If this is the tab we want to activate
            if (tabName === tabParam) {
              // Remove active classes from all tabs
              tabLinks.forEach(l => {
                l.classList.remove('w--current');
              });
              
              tabPanes.forEach(p => {
                p.classList.remove('w--tab-active');
              });
              
              // Add active classes to the selected tab
              link.classList.add('w--current');
              tabPanes[index].classList.add('w--tab-active');
            }
          });
        }
      });
  </script>
  <script> // Select all files checkboxes
    document.addEventListener('DOMContentLoaded', function() {
      // Select elements
      const selectAllCheckbox = document.getElementById('selectAllFiles');
      const fileCheckboxes = document.querySelectorAll('.file-checkbox');
      const deleteSelectedBtn = document.getElementById('deleteSelectedFiles');
      
      if (selectAllCheckbox) {
        // Toggle all checkboxes
        selectAllCheckbox.addEventListener('change', function() {
          const isChecked = this.checked;
          fileCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
          });
          
          updateDeleteButtonState();
        });
      }
      
      // Update select all checkbox when individual checkboxes change
      fileCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateSelectAllCheckbox();
          updateDeleteButtonState();
        });
      });
      
      // Delete selected files
      if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', async function() {
          if (!confirm('Are you sure you want to delete the selected files?')) return;
          
          const selectedFileIds = Array.from(document.querySelectorAll('.file-checkbox:checked'))
            .map(checkbox => checkbox.dataset.fileId);
          
          if (selectedFileIds.length === 0) return;
          
          try {
            const response = await fetch('/delete-selected-files', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ fileIds: selectedFileIds })
            });
            
            if (response.ok) {
              window.location.reload();
            } else {
              throw new Error('Failed to delete files');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete files: ' + error.message);
          }
        });
      }
      
      function updateSelectAllCheckbox() {
        if (!selectAllCheckbox) return;
        
        const totalCheckboxes = fileCheckboxes.length;
        const checkedCheckboxes = document.querySelectorAll('.file-checkbox:checked').length;
        
        selectAllCheckbox.checked = totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes;
        selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
      }
      
      function updateDeleteButtonState() {
        if (!deleteSelectedBtn) return;
        
        const anyChecked = document.querySelectorAll('.file-checkbox:checked').length > 0;
        deleteSelectedBtn.disabled = !anyChecked;
      }
    });
  </script>
  <script> // Info button modal functionality
    // Replace your info button modal code with this
    document.addEventListener('DOMContentLoaded', function() {
      // Info button in uploads page
      const uploadInfoButton = document.querySelector('.info-button');
      const uploadInfoModal = document.querySelector('.upload-info-modal');

      if (uploadInfoButton && uploadInfoModal) {
        // Add click handler to button
        uploadInfoButton.addEventListener('click', function(e) {
          console.log('Info button clicked');
          e.preventDefault();
          e.stopPropagation();
          uploadInfoModal.classList.add('active');
        });

        // Add close handlers
        const closeElements = uploadInfoModal.querySelectorAll('.modal-background, .cancel-button, .modal-return-button');
        closeElements.forEach(element => {
          element.addEventListener('click', function() {
            uploadInfoModal.classList.remove('active');
          });
        });
      } else {
        console.error('Upload info button or modal not found', {
          button: uploadInfoButton, 
          modal: uploadInfoModal
        });
      }
    });

    // Test function to manually show modal
    function showUploadInfoModal() {
      const modal = document.querySelector('.upload-info-modal');
      if (modal) {
        modal.classList.add('active');
        console.log("Modal should be visible now");
      } else {
        console.error("Modal element not found");
      }
    }
  </script>
  <!-- Add this script at the VERY END of your file, just before the closing </body> tag -->
  <script>
    (function() {
      // Wait for the page to be fully loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeModal);
      } else {
        initializeModal();
      }
      
      function initializeModal() {
        // Get modal elements
        const modal = document.getElementById('simpleInfoModal');
        const closeButton = document.getElementById('simpleModalCloseButton');
        const closeX = document.getElementById('simpleModalCloseX');
        const backButton = document.getElementById('simpleModalBackButton');
        
        // Get all info buttons (both our original and possibly others)
        const infoButtons = document.querySelectorAll('.info-button');
        
        // Adjust modal padding based on sidebar width
        function adjustModalPadding() {
          const sidebar = document.querySelector('.sidebar');
          if (sidebar) {
            const sidebarWidth = sidebar.offsetWidth;
            modal.style.paddingLeft = sidebarWidth + 'px';
            
            // Update the transparent area to match sidebar width
            const transparentArea = modal.querySelector('div:first-child');
            if (transparentArea) {
              transparentArea.style.width = sidebarWidth + 'px';
              transparentArea.style.left = -sidebarWidth + 'px';
            }
          }
        }
        
        // Function to show modal
        function showModal() {
          if (modal) {
            adjustModalPadding(); // Adjust padding before showing
            modal.style.display = 'block';
            
            // Add keydown event listener for Escape key
            document.addEventListener('keydown', handleEscKey);
          }
        }
        
        // Function to hide modal
        function hideModal() {
          if (modal) {
            modal.style.display = 'none';
            
            // Remove keydown event listener
            document.removeEventListener('keydown', handleEscKey);
          }
        }
        
        // Handle Escape key press
        function handleEscKey(e) {
          if (e.key === 'Escape') {
            hideModal();
          }
        }
        
        // Add event listeners to close buttons
        if (closeButton) {
          closeButton.addEventListener('click', hideModal);
        }
        
        if (closeX) {
          closeX.addEventListener('click', hideModal);
        }
        
        if (backButton) {
          backButton.addEventListener('click', hideModal);
        }
        
        // Add click handlers to all info buttons
        if (infoButtons.length > 0) {
          infoButtons.forEach(button => {
            button.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              showModal();
            });
          });
          console.log(`Added click handlers to ${infoButtons.length} info buttons`);
        } else {
          console.warn('No info buttons found');
        }
        
        // Click outside modal content to close (but not on the transparent sidebar area)
        modal.addEventListener('click', function(e) {
          // Close only if clicking the background, not the content or transparent sidebar area
          if (e.target === modal) {
            hideModal();
          }
        });
        
        // Make the functions available globally for debugging
        window.showInfoModal = showModal;
        window.hideInfoModal = hideModal;
        
        // Run adjustment once and on window resize
        adjustModalPadding();
        window.addEventListener('resize', adjustModalPadding);
        
        console.log('Modal initialization complete with matched styling');
      }
    })();
  </script>
  <script> // Dismiss notification
    document.addEventListener('DOMContentLoaded', function() {
      const notification = document.querySelector('.ocr-status-notification');
      const dismissButton = document.querySelector('.notification-dismiss');
      
      if (dismissButton && notification) {
        dismissButton.addEventListener('click', function() {
          notification.classList.add('dismissing');
          
          // Remove the element after animation completes
          setTimeout(() => {
            notification.classList.add('hidden');
          }, 300);
        });
      }
    });
</script>
</body>

</html>