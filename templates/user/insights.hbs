<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Insights</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link href="css/main-styles.css" rel="stylesheet" type="text/css" />
    <link href="css/user-styles.css" rel="stylesheet" type="text/css" />
    <link href="css/user-header-footer-styles.css" rel="stylesheet" type="text/css" />
    <link href="css/insights-styles.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  </head>

  <body class="user-body">
    {{> mobileUserHeader currentPage="insights"}}

    <div class="sidebar">
      <div class="sidebar-logo-wrapper">
        <div class="sidebar-logo-link">
          <img
            src="images/logo2.png"
            loading="lazy"
            alt="Logo"
            class="sidebar-logo"
        /></div>
      </div>
      <div class="nav-divider-basics nav-divider-top"></div>
      <a id="Profile" href="/profile" class="page-link w-inline-block">
        <img loading="lazy" src="images/user.svg" alt="Icon" class="nav-icon" />
        <div class="page-link-text-block">
          <span class="page-link-text-span">Profile</span>
        </div>
      </a>
      <a id="Upload" href="/upload" class="page-link w-inline-block">
        <img
          src="images/file-text.svg"
          loading="lazy"
          alt="Icon"
          class="nav-icon"
        />
        <div class="page-link-text-block">
          <span class="page-link-text-span">Upload</span>
        </div>
      </a>
      <a
        id="Reports"
        href="/reports"
        aria-current="page"
        class="page-link w-inline-block"
        ><img
          src="images/clipboard.svg"
          loading="lazy"
          alt="Icon"
          class="nav-icon"
        />
        <div class="page-link-text-block">
          <span class="page-link-text-span">Reports</span>
        </div>
      </a>
      <a
        id="Insights"
        href="/insights"
        class="page-link w-inline-block w--current"
      >
        <img
          src="images/layout.svg"
          loading="lazy"
          alt="Icon"
          class="nav-icon"
        />
        <div class="page-link-text-block">
          <span class="page-link-text-span">Insights</span>
        </div>
      </a>
      <a
        id="Chatbot"
        href="/chatbot"
        class="page-link w-inline-block"
      >
        <img
          src="images/chatbot.svg"
          loading="lazy"
          alt="Icon"
          class="nav-icon"
        />
        <div class="page-link-text-block">
          <span class="page-link-text-span">Ask</span>
        </div>
      </a>
      <div class="nav-divider-basics nav-divider-bottom"></div>
      <a id="Log-out" href="/logout" class="page-link w-inline-block" onclick="return confirmLogout(event)">
        <img
          src="images/unlock.svg"
          loading="lazy"
          alt="Icon"
          class="nav-icon"
        />
        <div class="page-link-text-block">
          <span class="page-link-text-span">Log out</span>
        </div>
      </a>
      <div class="sidebar-bottom-spacer"></div>
    </div>

    <section class="demo-header">
      <div class="header-container-2">
        <div>
          <h2 class="heading2">Insights Dashboard</h2>
          <h3 class="subheading"></h3>
          <div class="spacer-block"></div>
        </div>
      </div>
    </section>

    <div class="dashboard-content">
      <div class="dashboard-container">
        <div class="w-layout-grid main-grid">
          <div class="tabs w-tabs">
            <!-- Tab Menu -->
            <div class="in-page-menu w-tab-menu">
              <a
                data-w-tab="Dashboard"
                class="in-page-link w-inline-block w-tab-link w--current"
              >
                <div class="text-block">Dashboard</div>
              </a>
              <a
                data-w-tab="Actions"
                class="in-page-link w-inline-block w-tab-link"
              >
                <div class="text-block">Actions</div>
              </a>
            </div>

            <!-- Tab Content -->
            <div class="w-tab-content">
              <!-- Dashboard Tab -->
              <div data-w-tab="Dashboard" class="w-tab-pane">
                <!-- Hidden data elements -->
                <div
                    id="wellnessData"
                    data-scores="{{json scores}}"
                    data-recommendations="{{json recommendations}}"
                    style="display: none"
                  ></div>
                <div 
                    id="labSummaryData" 
                    data-labs="{{json biomarkerSummary}}" 
                    style="display: none">
                  </div>

                <!-- Two Column Grid Layout -->
                <div class="dashboard-grid">
                  
                  <!-- LEFT COLUMN: Labs Summary -->
                  <div class="dashboard-left-column">
                    <div class="wellness-summary-card">
                      <div class="labs-summary-header">
                        <div class="labs-title-wrapper">
                          <h2 class="insights-title">Labs Summary</h2>
                        </div>
                      </div>

                      <!-- React component will render here -->
                      <div id="labs-summary-recharts-root"></div>
                    </div>
                  </div>

                  <!-- RIGHT COLUMN: Wellness Scores -->
                  <div class="dashboard-right-column">

                    <!-- Overall Wellness Score -->
                    <div class="wellness-summary-card">
                      <div class="insights-header">
                        <div class="insights-title-wrapper">
                          <h2 class="insights-title">Overall Wellness Score</h2>
                          <button class="info-button" aria-label="Show wellness information">
                            {{> svg/info}}
                          </button>
                        </div>
                      </div>

                      <div class="wellness-content dashboard-wellness-content">
                        <div class="wellness-chart-container">
                      <div class="chart-wrapper">
                        <svg viewBox="0 0 100 100" class="circular-chart">
                          <!-- Background circle -->
                          <circle cx="50" cy="50" r="26" fill="white" />

                          <!-- Score circle -->
                          <circle
                            cx="50"
                            cy="50"
                            r="26"
                            fill="none"
                            stroke="#eee"
                            stroke-width="6"
                            class="circle-bg"
                          />
                          <circle
                            cx="50"
                            cy="50"
                            r="26"
                            fill="none"
                            stroke-width="6"
                            class="circle-progress"
                            id="scoreCircle"
                          />
                        </svg>

                        <!-- Tooltip -->
                        <div class="chart-tooltip"></div>

                        <!-- Score circle overlaid on chart -->
                        <div class="score-circle">
                          <span class="score-number"
                            >{{calculateCompletionPercentage
                            scores.inputs}}</span
                          >
                          <span class="score-max">/100</span>
                        </div>
                      </div>
                    </div>
                      </div>
                    </div>

                    <!-- Wellness Score Inputs -->
                    <div class="wellness-summary-card">
                      <div class="insights-header">
                    <div class="insights-title-wrapper">
                      <h2 class="insights-title">Wellness Score Inputs</h2>
                      <button
                        class="info-button"
                        aria-label="Show wellness information"
                      >
                        {{> svg/info}}
                      </button>
                    </div>
                  </div>

                  <div class="wellness-content dashboard-wellness-content" style="display: block;">
                    <!-- Categories -->
                    <div class="wellness-categories" style="max-width: 100%; flex: none;">
                      <!-- Prevention Section -->
                      <div class="category-section">
                        <div class="category-header">
                          <h3>Inputs</h3>
                          <div class="category-score">
                            <span id="totalScore"
                              >{{calculateCompletionPercentage
                              scores.inputs}}</span
                            >%
                          </div>
                        </div>
                        <div class="metric-list">
                          {{#each scores.inputs}}
                          <div class="metric-item" data-metric="{{@key}}">
                            <span class="metric-name">{{@key}}</span>
                            <div class="metric-status">
                              {{#if this}} {{> svg/checkCircle}} {{else}}
                              <span class="incomplete">√ó </span>
                              {{/if}}
                            </div>
                            <span class="metric-arrow">‚Ä∫</span>
                          </div>
                          <div class="metric-dropdown">
                            <div class="metric-detail">
                              <span class="metric-label">Current Status:</span>
                              <span
                                class="metric-value {{#if this}}status-complete{{else}}status-incomplete{{/if}}"
                              >
                                {{#if this}}Completed{{else}}Incomplete{{/if}}
                              </span>
                            </div>
                            <div class="metric-detail">
                              <span class="metric-label">Description:</span>
                              <span class="metric-value"
                                >Track your {{@key}} to improve your wellness
                                score</span
                              >
                            </div>
                            <div class="metric-detail">
                              <span class="metric-label">Action required:</span>
                              <span class="metric-value">
                                {{#unless this}} Add your {{@key}} information
                                {{else}} Your {{@key}} information is complete
                                {{/unless }}
                              </span>
                            </div>
                            {{#unless this}}
                            <a
                              href="{{getMetricUrl @key}}"
                              class="metric-action"
                              >Update {{@key}}</a
                            >
                            {{/unless }}
                          </div>
                          {{/each}}
                        </div>
                      </div>
                    </div>

                    <!-- Right side: Chart -->
                    
                      </div>
                    </div>
                  </div>

                  <!-- Info Modal for Wellness Score Inputs -->
                  <div class="info-modal" style="display: none">
                    <div class="modal-content">
                      <button class="modal-close">&times;</button>
                      <h3>About Wellness Score Inputs</h3>
                      <p>
                        Your wellness score is calculated based on the
                        completion of health metrics across four categories:
                      </p>
                      <ul>
                        <li>
                          <strong>Inputs:</strong> Basic health data like
                          age, height, weight, and BMI
                        </li>
                        <li>
                          <strong>Prevention:</strong> Preventive health
                          measures and screenings
                        </li>
                        <li>
                          <strong>Optimization:</strong> Advanced health
                          metrics for optimal wellness
                        </li>
                        <li>
                          <strong>Longevity:</strong> Long-term health
                          indicators
                        </li>
                      </ul>
                      <p>
                        Click on any metric to see recommendations for
                        improvement.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Labs Info Modal -->
              <div class="modal-wrapper labs-info-modal">
                <div class="modal-background"></div>
                <div class="modal-card">
                  <div class="modal-header">
                    <a class="modal-return-button w-inline-block w--current" aria-current="page">
                      {{> svg/backArrow}}
                    </a>
                    <h1 class="modal-button">Labs Summary Information</h1>
                  </div>

                  <div class="modal-description">
                    <p>This summary provides an overview of your lab biomarkers:</p>
                    <ul>
                      <li><strong>In Range:</strong> The number of biomarkers that fall within the normal reference range.</li>
                      <li><strong>Out of Range:</strong> Biomarkers that are either higher or lower than the normal reference range.</li>
                      <li><strong>Improving:</strong> Biomarkers that were previously out of range but are now trending toward the normal range based on your latest results.</li>
                    </ul>
                    <p>Regular monitoring of these values can help you track your health progress over time.</p>
                  </div>

                  <div class="modal-footer">
                    <a href="/insights" aria-current="page" class="cancel-button cancel-space">Close</a>
                  </div>
                </div>
              </div>

              <!-- Actions Tab -->
              <div data-w-tab="Actions" class="w-tab-pane">
                <div class="wellness-summary-card">
                  <div class="recommendations-wrapper">
                    <div class="recommendations-header">
                      <h2 class="insights-title">Recommended Actions</h2>
                      <p class="recommendations-subtitle">
                        Personalized recommendations based on your health profile and lab data
                      </p>
                    </div>

                    <!-- Check if user has minimal data (no files AND low profile completion) -->
                    {{#unless recentFiles}}
                      {{#if (lt totalScore 25)}}
                        <!-- No data state - show when user has no files and very low profile completion -->
                        <div class="no-data-state">
                          <p class="no-data-subtitle">
                            Please enter data in your profile page and/or upload lab files to receive personalized health recommendations.
                          </p>
                          <div class="no-data-actions">
                            <a href="/profile" class="action-button profile-button-primary">
                              üë§ Complete Your Profile
                            </a>
                            <a href="/upload" class="action-button upload-button-primary">
                              üìÅ Upload Lab Results
                            </a>
                          </div>
                        </div>
                      {{/if}}
                    {{else}}
                      <!-- Debug information (you can remove this section once everything is working) -->
                      <div class="debug-info">
                        <p class="recommendation-count">Total recommendations: {{#if recommendations}}{{recommendations.length}}{{else}}0{{/if}}</p>
                      </div>
                      
                      <!-- Recommendations list -->
                      {{#if recommendations}}
                        <div class="recommendations-list">
                          {{#each recommendations as |recommendation|}}
                            <div class="recommendation-item {{#if recommendation.priority}}{{recommendation.priority}}-priority{{/if}}">
                              <div class="recommendation-text">
                                {{#if recommendation.text}}
                                  {{formatBiomarkerText recommendation.text}}
                                {{else}}
                                  {{formatBiomarkerText recommendation}}
                                {{/if}}
                              </div>
                              {{#if recommendation.type}}
                                <small class="recommendation-meta">
                                  {{#if (eq recommendation.type 'biomarker')}}üß™{{else}}üë§{{/if}}
                                  {{#if (eq recommendation.type 'biomarker')}}Lab Test{{else}}Health Profile{{/if}}
                                  {{#if recommendation.priority}}‚Ä¢ Priority: {{recommendation.priority}}{{/if}}
                                </small>
                              {{/if}}
                            </div>
                          {{/each}}
                        </div>
                      {{else}}
                        <!-- No recommendations state -->
                        <div class="no-recommendations">
                          <div class="no-recommendations-icon">üéâ</div>
                          <p class="no-recommendations-title"><strong>Great job!</strong> You're on top of your health tracking.</p>
                          <p class="no-recommendations-subtitle">Upload recent lab results or complete more profile sections to get additional personalized recommendations.</p>
                          <div class="no-recommendations-actions">
                            <a href="/upload" class="action-button upload-button">üìÅ Upload Labs</a>
                            <a href="/profile" class="action-button profile-button">üë§ Complete Profile</a>
                          </div>
                        </div>
                      {{/if}}
                    {{/unless}}
                    
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    {{!-- Wellness Info Modal--}}
    <div class="modal-wrapper wellness-info">
      <div class="modal-background"></div>
      <div class="modal-card">
        <div class="modal-header">
          <a
            class="modal-return-button w-inline-block w--current"
            aria-current="page"
          >
            {{> svg/backArrow}}
          </a>
          <h1 class="modal-button">Wellness Indicators</h1>
        </div>

        <div class="modal-description">
          These "Wellness Scores" are a simple estimation of how well you're
          doing at preventive health. Each preventive action is backed by hard
          science, and you can follow the hyperlinks in each description to
          learn more from the source. Don't worry if your score is low. This
          usually just means you haven't entered much data or connected many
          sources yet. To get the most out of your Wellness Score, click into
          each score factor to learn what data you need to add and how to
          improve it.
        </div>

        <div class="modal-footer">
          <a
            href="/insights"
            aria-current="page"
            class="cancel-button cancel-space"
            >Close</a
          >
        </div>
      </div>
    </div>

    {{!-- Wellness Metrics Modal--}}
    <div class="modal-wrapper modal-wrapper-6">
      <div class="modal-background"></div>
      <div class="modal-card wellness-metrics">
        <div class="modal-header">
          <a
            class="modal-return-button w-inline-block w--current"
            data-w-id="e51537ba-0bb8-7d9d-b7be-455102aac1f4"
            aria-current="page"
          >
            {{> svg/backArrow}}
          </a>
          <h1 class="modal-button">Wellness Score</h1>
          <div class="score-circle">0</div>
        </div>

        <div class="metrics-section">
          <h2 class="metrics-heading">Prevention</h2>
          <div class="metrics-list">
            <div class="metric-item">
              <span>Medical checkup ‚Ä¢ last 2 years</span>
              <span class="metric-status">‚úï</span>
              <span class="metric-arrow">‚Ä∫</span>
            </div>
            <!-- Add other prevention metrics similarly -->
          </div>

          <h2 class="metrics-heading">Monitoring</h2>
          <div class="metrics-list">
            <div class="metric-item">
              <span>Active provider connection</span>
              <span class="metric-status">‚úï</span>
              <span class="metric-arrow">‚Ä∫</span>
            </div>
            <!-- Add other monitoring metrics -->
          </div>

          <h2 class="metrics-heading">Actions</h2>
          <div class="metrics-list">
            <div class="metric-item">
              <span>Sleep 7+ hours daily ‚Ä¢ last 7 days</span>
              <span class="metric-arrow">‚Ä∫</span>
            </div>
            <!-- Add other action metrics -->
          </div>
        </div>
        <div class="metrics-footer">
          <small>Click on a score factor above to see details</small>
          <small>Factors are personalized by age and sex</small>
          <small
            >The score is mainly preventive, it is not a complete picture of
            your health</small
          >
          <small
            >New factors and personal insights will be added over time</small
          >
        </div>
      </div>
    </div>

    <section class="background report-background">
      <div class="w-layout-blockcontainer container-4 w-container"></div>
    </section>
    
    <script
      src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=6606de22e8c152e6b19be98a"
      type="text/javascript"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script src="js/main.js" type="text/javascript"></script>
    <script src="js/main-user.js" defer type="module"></script>
    <script src="js/wellnessScore.js" type="text/javascript"></script>
    <script src="js/mobile-logout.js"></script>
    <script src="js/sidebar-logout.js"></script>
    <script>// modals

      // Info button modal
      document.querySelector(".info-button").addEventListener("click", () => {
        document.querySelector(".wellness-info").classList.add("active");
      });

      // Wellness metrics modal
      document
        .querySelector(".edit-button-modal")
        .addEventListener("click", (e) => {
          e.preventDefault();
          document.querySelector(".modal-wrapper-6").classList.add("active");
        });

      // Close handlers
      document
        .querySelectorAll(".modal-background, .cancel-button")
        .forEach((element) => {
          element.addEventListener("click", () => {
            document
              .querySelectorAll(".wellness-info, .modal-wrapper-6")
              .forEach((modal) => {
                modal.classList.remove("active");
              });
          });
        });

      // Return button
      document.querySelectorAll(".modal-return-button").forEach((button) => {
        button.addEventListener("click", () => {
          document
            .querySelectorAll(".wellness-info, .modal-wrapper-6")
            .forEach((modal) => {
              modal.classList.remove("active");
            });
        });
      });
    </script>
    <script> // wellness chart animations
      function updateScoreCircle(score) {
        const circle = document.getElementById("scoreCircle");
        const scoreCircleElement = document.getElementById(".score-circle");

        // Calculate circle properties
        const radius = 26;
        const circumference = 2 * Math.PI * radius;
        // Calculate offset (reversed to fill clockwise from top)
        const offset = ((100 - score) / 100) * circumference;

        // Set circle properties
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = offset;

        // Set color based on score
        let color;
        if (score >= 75) {
          color = "#71b871"; // Green
        } else if (score >= 50) {
          color = "#ffd700"; // Yellow
        } else {
          color = "#ff6b6b"; // Red
        }

        circle.style.stroke = color;
        scoreCircleElement.style.borderColor = color;
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Get the score from the totalScore element that was rendered from server
        const score = parseInt(
          document.getElementById("totalScore").textContent
        );

        // Update the circle display
        document.querySelector(".score-number").textContent = score;
        updateScoreCircle(score);
      });
    </script>
    <script> // metric dropdown
      document.addEventListener("DOMContentLoaded", function () {
        // Get all metric items
        const metricItems = document.querySelectorAll(".metric-item");

        // Add click event listener to each metric item
        metricItems.forEach((metricItem) => {
          metricItem.addEventListener("click", function () {
            // Toggle active class on the clicked metric item
            this.classList.toggle("active");

            // Get the metric dropdown element (it follows the metric item in DOM)
            const metricDropdown = this.nextElementSibling;

            // If dropdown doesn't exist, we don't need to do anything
            if (
              !metricDropdown ||
              !metricDropdown.classList.contains("metric-dropdown")
            ) {
              return;
            }

            // Toggle the dropdown visibility
            if (this.classList.contains("active")) {
              metricDropdown.style.maxHeight =
                metricDropdown.scrollHeight + "px";
              metricDropdown.style.opacity = "1";
            } else {
              metricDropdown.style.maxHeight = "0";
              metricDropdown.style.opacity = "0";
            }

            // Close other open dropdowns
            metricItems.forEach((item) => {
              if (item !== this && item.classList.contains("active")) {
                item.classList.remove("active");
                const dropdown = item.nextElementSibling;
                if (
                  dropdown &&
                  dropdown.classList.contains("metric-dropdown")
                ) {
                  dropdown.style.maxHeight = "0";
                  dropdown.style.opacity = "0";
                }
              }
            });
          });
        });
      });
    </script>
    <script> // RAG Chat functionality
      document.addEventListener("DOMContentLoaded", function () {
        const chatMessages = document.getElementById("chat-messages");
        const chatInput = document.getElementById("chat-input");
        const chatSubmit = document.getElementById("chat-submit");

        // Auto-resize textarea
        chatInput.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = this.scrollHeight + "px";
        });

        // Submit on Enter (but allow Shift+Enter for new lines)
        chatInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            submitMessage();
          }
        });

        // Submit button click
        chatSubmit.addEventListener("click", submitMessage);

        function submitMessage() {
          const message = chatInput.value.trim();
          if (!message) return;

          // Add user message to chat
          addMessage(message, "user");

          // Clear input
          chatInput.value = "";
          chatInput.style.height = "auto";

          // Show typing indicator
          addTypingIndicator();

          // Send to RAG API
          sendToRAG(message);
        }

        function addMessage(message, sender) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `chat-message ${sender}-message`;

          const messageContent = document.createElement("div");
          messageContent.className = "message-content";

          // Parse markdown-like formatting for code blocks and links
          const formattedText = formatMessage(message);
          messageContent.innerHTML = `<p>${formattedText}</p>`;

          messageDiv.appendChild(messageContent);
          chatMessages.appendChild(messageDiv);

          // Scroll to bottom
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(text) {
          // Handle code blocks (```code```)
          text = text.replace(
            /```([\s\S]*?)```/g,
            "<pre><code>$1</code></pre>"
          );

          // Handle inline code (`code`)
          text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

          // Handle links
          text = text.replace(
            /\[(.*?)\]\((.*?)\)/g,
            '<a href="$2" target="_blank">$1</a>'
          );

          // Handle line breaks
          text = text.replace(/\n/g, "<br>");

          return text;
        }

        function addTypingIndicator() {
          const typingDiv = document.createElement("div");
          typingDiv.className = "chat-message assistant-message typing";
          typingDiv.innerHTML = `
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          `;
          chatMessages.appendChild(typingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
          const typingIndicator = document.querySelector(".typing");
          if (typingIndicator) {
            typingIndicator.remove();
          }
        }

        async function sendToRAG(query) {
          try {
            // STEP 1: Try to get current user ID
            console.log('Getting current user ID...');
            let userId = null;
            
            try {
              const userIdResponse = await fetch("/api/current-user");
              if (userIdResponse.ok) {
                const userData = await userIdResponse.json();
                userId = userData.userId;
                console.log('User ID retrieved:', userId);
              } else {
                console.log('User not authenticated, proceeding without context');
              }
            } catch (userError) {
              console.log('Error getting user ID, proceeding without context:', userError);
            }
            
            // STEP 2: Get user context only if we have a userId
            let userContext = null;
            
            if (userId) {
              try {
                const contextResponse = await fetch("/api/rag/context", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ userId: userId })
                });
                
                if (contextResponse.ok) {
                  const contextData = await contextResponse.json();
                  userContext = contextData.userContext;
                  console.log('User context retrieved:', userContext);
                }
              } catch (contextError) {
                console.error('Error getting user context:', contextError);
              }
            }
            
            // STEP 3: Send to RAG with context (if available)
            const response = await fetch("/api/rag/ask", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ 
                query,
                userContext: userContext
              }),
            });

            const data = await response.json();
            
            // Remove typing indicator
            removeTypingIndicator();

            // Add response to chat
            addMessage(data.response, "assistant");

            // Store sources for info button
            window.lastSources = data.sources;
            
          } catch (error) {
            console.error("Error:", error);
            removeTypingIndicator();
            addMessage(
              "Sorry, I couldn't process your request. Please try again.",
              "assistant"
            );
          }
        }

        // Add info button functionality to show sources
        document
          .querySelector('[data-w-tab="Ask"] .info-button')
          .addEventListener("click", function () {
            showChatInfoModal();
          });

        function showChatInfoModal() {
          // Create sources HTML if available
          let sourcesHTML = "";
          if (window.lastSources && window.lastSources.length > 0) {
            sourcesHTML = "<h3>Last Query Sources:</h3>";
            window.lastSources.forEach((source) => {
              sourcesHTML += `
          <div class="source-item">
            <div class="source-title">${source.title}</div>
            <div class="source-similarity">Relevance: ${Math.round(
              source.similarity * 100
            )}%</div>
          </div>
        `;
            });
          }

          // Show modal with chat info and sources
          const modal = document.createElement("div");
          modal.id = "chatInfoModal";
          modal.className = "modal-wrapper wellness-info active";
          modal.innerHTML = `
            <div class="modal-background"></div>
            <div class="modal-card">
              <div class="modal-header">
                <a class="modal-return-button w-inline-block w--current" aria-current="page">
                  {{> svg/backArrow}}
                </a>
                <h1 class="modal-button">About Reed</h1>
              </div>
              <div class="modal-description">
                <p>Reed is your health knowledge assistant powered by retrieval-augmented generation (RAG). Reed only provides information based on trusted health resources in our database.</p>
                <p>Unlike generic AI chatbots, Reed doesn't make things up - it will only answer with information it can find in reliable sources.</p>
                <p>Note that Reed is currently in early development with a limited knowledge base. We're using free embeddings and a lightweight model, which can often leave a disappointing response quality. As we expand our database and upgrade to premium services, you can expect significantly improved accuracy and more comprehensive answers.</p>
                ${sourcesHTML}
              </div>
              <div class="modal-footer">
                <a href="#" aria-current="page" class="cancel-button cancel-space">Close</a>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // Add event listeners to close modal
          modal
            .querySelector(".modal-background")
            .addEventListener("click", () => modal.remove());
          modal
            .querySelector(".cancel-button")
            .addEventListener("click", () => modal.remove());
          modal
            .querySelector(".modal-return-button")
            .addEventListener("click", () => modal.remove());
        }
        initializeChatbotCardResize();
      });
    </script>
    {{!-- <script> // Labs Summary JavaScript
      document.addEventListener('DOMContentLoaded', function() {
        // Check if we're on the insights page with the Labs Summary tab
        const labSummaryTab = document.querySelector('[data-w-tab="LabsSummary"]');
        if (!labSummaryTab) return;

        // Add tab change listener to ensure stats update when tab is viewed
        document.querySelectorAll('.in-page-link').forEach(tabLink => {
          tabLink.addEventListener('click', function() {
            if (this.getAttribute('data-w-tab') === 'LabsSummary') {
              setTimeout(animateLabStats, 150);
            }
          });
        });

        // Get labs data from the hidden element
        function getLabsData() {
          const dataElement = document.getElementById('labSummaryData');
          if (!dataElement) return { inRange: 0, outOfRange: 0, improving: 0 };
          
          try {
            return JSON.parse(dataElement.getAttribute('data-labs'));
          } catch (e) {
            console.error('Error parsing labs data:', e);
            return { inRange: 0, outOfRange: 0, improving: 0 };
          }
        }

        // Animate stats with counting effect
        function animateLabStats() {
          const labsData = getLabsData();
          
          animateCounter('inRangeCount', labsData.inRange || 0);
          animateCounter('outOfRangeCount', labsData.outOfRange || 0);
          animateCounter('improvingCount', labsData.improving || 0);
          
          // Animate chart bars
          animateChartBars(labsData);
        }

        // Counter animation function
        function animateCounter(elementId, targetValue) {
          const element = document.getElementById(elementId);
          if (!element) return;
          
          const countDisplay = element.querySelector('.count-number');
          if (!countDisplay) return;
          
          // Get current value
          const startValue = parseInt(countDisplay.textContent) || 0;
          const duration = 1000; // Animation duration in ms
          const stepTime = 20; // ms per step
          const steps = duration / stepTime;
          const increment = (targetValue - startValue) / steps;
          
          let currentValue = startValue;
          let currentStep = 0;
          
          const animation = setInterval(() => {
            currentStep++;
            currentValue += increment;
            
            if (currentStep >= steps) {
              clearInterval(animation);
              currentValue = targetValue;
            }
            
            countDisplay.textContent = Math.round(currentValue);
            
            if (currentStep >= steps) {
              // Add a slight bounce effect at the end
              element.style.transform = 'scale(1.05)';
              setTimeout(() => {
                element.style.transform = 'scale(1)';
              }, 100);
            }
          }, stepTime);
        }

        // Animate the chart bars
        function animateChartBarsPercentage(labsData) {
          const chartBars = document.querySelectorAll('.chart-bar');
          if (chartBars.length < 4) return;
          
          // Get all values
          const inRangeValue = labsData.inRange || 0;
          const improvingValue = labsData.improving || 0;
          const outOfRangeValue = labsData.outOfRange || 0;
          const decliningValue = labsData.declining || 0;
          
          // Calculate total biomarkers
          const totalBiomarkers = inRangeValue + improvingValue + outOfRangeValue + decliningValue;
          
          // Base height settings
          const maxBarHeight = 180;
          const minBarHeight = 8;
          
          // Apply heights with animation - using percentage of total
          setTimeout(() => {
            chartBars[0].style.height = `${calculatePercentageHeight(inRangeValue, totalBiomarkers, maxBarHeight, minBarHeight)}px`;
            chartBars[1].style.height = `${calculatePercentageHeight(improvingValue, totalBiomarkers, maxBarHeight, minBarHeight)}px`;
            chartBars[2].style.height = `${calculatePercentageHeight(outOfRangeValue, totalBiomarkers, maxBarHeight, minBarHeight)}px`;
            chartBars[3].style.height = `${calculatePercentageHeight(decliningValue, totalBiomarkers, maxBarHeight, minBarHeight)}px`;
          }, 300);
          
          // Calculate height based on percentage of total biomarkers
          function calculatePercentageHeight(value, total, maxHeight, minHeight) {
            if (value === 0 || total === 0) return minHeight;
            
            // Calculate percentage of total
            const percentage = value / total;
            
            // Scale from minHeight to maxHeight based on percentage
            const scaledHeight = minHeight + (maxHeight - minHeight) * percentage;
            
            return Math.round(scaledHeight);
          }
        }

        // Info button modal functionality
        const labsInfoButton = labSummaryTab.querySelector('.info-button');
        if (labsInfoButton) {
          labsInfoButton.addEventListener('click', () => {
            document.querySelector('.labs-info-modal').classList.add('active');
          });
        }

        // Close modal handlers
        document.querySelectorAll('.labs-info-modal .modal-background, .labs-info-modal .cancel-button, .labs-info-modal .modal-return-button').forEach(element => {
          element.addEventListener('click', () => {
            document.querySelector('.labs-info-modal').classList.remove('active');
          });
        });

         // Close modal handlers
        document.querySelectorAll('.wellness-info .modal-background, .wellness-info .cancel-button, .wellness-info .modal-return-button').forEach(element => {
          element.addEventListener('click', () => {
            document.querySelector('.wellness-info').classList.remove('active');
          });
        });

        // Run animation on initial load if the Labs Summary tab is active
        if (labSummaryTab.classList.contains('w--tab-active')) {
          setTimeout(animateLabStats, 300);
        }
      });
    </script> --}}
    {{!-- <script> // empty state bar charts
      document.addEventListener('DOMContentLoaded', function() {
        // Check for empty state (all values are zero)
        function checkForEmptyState() {
          const biomarkerSummary = getBiomarkerSummary();
          const isEmpty = biomarkerSummary.inRange === 0 && 
                          biomarkerSummary.improving === 0 && 
                          biomarkerSummary.outOfRange === 0 && 
                          biomarkerSummary.declining === 0;
          
          // Apply or remove empty state class based on the check
          const chartContainer = document.querySelector('.lab-stats-chart');
          if (chartContainer) {
            if (isEmpty) {
              chartContainer.classList.add('empty-state');
            } else {
              chartContainer.classList.remove('empty-state');
            }
          }
          
          return isEmpty;
        }
        
        // Get biomarker summary data from the hidden element
        function getBiomarkerSummary() {
          const dataElement = document.getElementById('labSummaryData');
          if (!dataElement) {
            return { inRange: 0, outOfRange: 0, improving: 0, declining: 0 };
          }
          
          try {
            return JSON.parse(dataElement.getAttribute('data-labs')) || 
                  { inRange: 0, outOfRange: 0, improving: 0, declining: 0 };
          } catch (e) {
            console.error('Error parsing biomarker data:', e);
            return { inRange: 0, outOfRange: 0, improving: 0, declining: 0 };
          }
        }
        
        // Update chart based on data
        function updateChartDisplay() {
          const isEmpty = checkForEmptyState();
          const chartContainer = document.querySelector('.chart-container');
          
          if (!chartContainer) return;
          
          // If empty, make sure we have the empty state message
          if (isEmpty && !document.querySelector('.empty-state-text')) {
            const emptyText = document.createElement('div');
            emptyText.className = 'empty-state-text';
            emptyText.textContent = 'Upload lab results to see your biomarker data';
            chartContainer.insertAdjacentElement('afterend', emptyText);
          }
          
          // Set chart bar heights for empty state
          if (isEmpty) {
            const chartBars = document.querySelectorAll('.chart-bar');
            chartBars.forEach(bar => {
              bar.style.height = '10px';
            });
          }
        }
        
        // Run the check when the page loads
        updateChartDisplay();
        
        // You might want to run this again if the tab changes
        document.querySelectorAll('.in-page-link').forEach(tab => {
          tab.addEventListener('click', function() {
            if (this.getAttribute('data-w-tab') === 'LabsSummary') {
              setTimeout(updateChartDisplay, 100);
            }
          });
        });
      });
    </script> --}}
    <script> // chat-messages size adjuster
      function initializeChatbotCardResize() {
        const chatbotCard = document.querySelector('.chatbot-card');
        const chatMessages = document.getElementById('chat-messages');
        const resizeHandle = document.querySelector('.chatbot-resize-handle');
        
        if (!chatbotCard || !chatMessages || !resizeHandle) return;
        
        let isResizing = false;
        let startY = 0;
        let startChatHeight = 0;
        let startCardHeight = 0;
        
        // Mouse events for desktop
        resizeHandle.addEventListener('mousedown', initResize);
        document.addEventListener('mousemove', doResize);
        document.addEventListener('mouseup', stopResize);
        
        // Touch events for mobile
        resizeHandle.addEventListener('touchstart', initResizeTouch, { passive: false });
        document.addEventListener('touchmove', doResizeTouch, { passive: false });
        document.addEventListener('touchend', stopResize);
        
        function initResize(e) {
          isResizing = true;
          startY = e.clientY;
          startChatHeight = parseInt(window.getComputedStyle(chatMessages).height, 10);
          startCardHeight = parseInt(window.getComputedStyle(chatbotCard).height, 10);
          document.body.style.userSelect = 'none';
          e.preventDefault();
        }
        
        function initResizeTouch(e) {
          isResizing = true;
          startY = e.touches[0].clientY;
          startChatHeight = parseInt(window.getComputedStyle(chatMessages).height, 10);
          startCardHeight = parseInt(window.getComputedStyle(chatbotCard).height, 10);
          document.body.style.userSelect = 'none';
          e.preventDefault();
        }
        
        function doResize(e) {
          if (!isResizing) return;
          
          const currentY = e.clientY;
          const diff = currentY - startY;
          const newChatHeight = startChatHeight + diff;
          const newCardHeight = startCardHeight + diff;
          
          // Set min and max heights with separate tablet handling
          let minChatHeight, maxChatHeight;

          if (window.innerWidth <= 767) {
            // Mobile (‚â§767px)
            minChatHeight = 120;
            maxChatHeight = Math.min(window.innerHeight * 0.6, 600);
          } else if (window.innerWidth <= 1024) {
            // Tablet (768px-1024px)
            minChatHeight = 170;
            maxChatHeight = Math.min(window.innerHeight * 0.69, 775);
          } else {
            // Desktop (>1024px)
            minChatHeight = 110;
            maxChatHeight = Math.min(window.innerHeight * 0.8, 1000);
          }
          
          if (newChatHeight >= minChatHeight && newChatHeight <= maxChatHeight) {
            // Resize chat-messages directly
            chatMessages.style.height = newChatHeight + 'px';
            chatMessages.style.flex = 'none';
            
            // Resize chatbot-card indirectly
            chatbotCard.style.height = newCardHeight + 'px';
            chatbotCard.style.minHeight = 'auto';
          }
        }
        
        function doResizeTouch(e) {
          if (!isResizing) return;
          
          const currentY = e.touches[0].clientY;
          const diff = currentY - startY;
          const newChatHeight = startChatHeight + diff;
          const newCardHeight = startCardHeight + diff;
          
          // Set min and max heights with separate tablet handling (same as doResize)
          let minChatHeight, maxChatHeight;

          if (window.innerWidth <= 767) {
            // Mobile (‚â§767px)
            minChatHeight = 120;
            maxChatHeight = Math.min(window.innerHeight * 0.6, 600);
          } else if (window.innerWidth <= 1024) {
            // Tablet (768px-1024px)
            minChatHeight = 170;
            maxChatHeight = Math.min(window.innerHeight * 0.69, 775); // Same as your doResize
          } else {
            // Desktop (>1024px)
            minChatHeight = 300;
            maxChatHeight = Math.min(window.innerHeight * 0.8, 1000);
          }
          
          if (newChatHeight >= minChatHeight && newChatHeight <= maxChatHeight) {
            chatMessages.style.height = newChatHeight + 'px';
            chatMessages.style.flex = 'none';
            
            chatbotCard.style.height = newCardHeight + 'px';
            chatbotCard.style.minHeight = 'auto';
          }
          
          e.preventDefault();
        }
        
        function stopResize() {
          isResizing = false;
          document.body.style.userSelect = '';
        }
      }
    </script>
    <script> // Notification
      (function() {
        'use strict';
        
        function initNotification() {
          try {
            const askTabNotification = document.getElementById('askTabNotification');
            const tabLinks = document.querySelectorAll('.in-page-link');
            const closeButton = document.querySelector('.notification-close');
            
            if (!askTabNotification || tabLinks.length === 0) {
              return;
            }
            
            // Check if notification was previously dismissed
            const notificationDismissed = localStorage.getItem('askTabNotificationDismissed');
            
            function showNotification() {
              if (notificationDismissed) return;
              
              askTabNotification.style.display = 'block';
              askTabNotification.style.opacity = '0';
              askTabNotification.style.transform = 'translateY(-10px)';
              askTabNotification.style.transition = 'all 0.3s ease';
              
              setTimeout(() => {
                askTabNotification.style.opacity = '1';
                askTabNotification.style.transform = 'translateY(0)';
              }, 50);
            }
            
            function hideNotification() {
              askTabNotification.style.opacity = '0';
              askTabNotification.style.transform = 'translateY(-10px)';
              
              setTimeout(() => {
                askTabNotification.style.display = 'none';
              }, 300);
            }
            
            function dismissNotification() {
              hideNotification();
              localStorage.setItem('askTabNotificationDismissed', 'true');
            }
            
            function checkActiveTab() {
              const activeTab = document.querySelector('.in-page-link.w--current');
              
              if (activeTab && activeTab.getAttribute('data-w-tab') === 'Ask') {
                showNotification();
              } else {
                hideNotification();
              }
            }
            
            // IMPORTANT: Don't interfere with existing tab system
            // Just listen for tab clicks, don't modify classes
            tabLinks.forEach((link) => {
              link.addEventListener('click', function() {
                // Let the existing tab system handle the class changes
                // Just check after a delay
                setTimeout(checkActiveTab, 200);
              });
            });
            
            // Also observe for class changes made by existing tab system
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'class' && 
                    mutation.target.classList.contains('in-page-link')) {
                  setTimeout(checkActiveTab, 50);
                }
              });
            });
            
            // Observe all tab links for class changes
            tabLinks.forEach(link => {
              observer.observe(link, { attributes: true });
            });
            
            // Close button functionality
            if (closeButton) {
              closeButton.addEventListener('click', dismissNotification);
            }
            
            // Note: Auto-hide timer removed - notification only dismisses when user clicks X
            
            // Check initial state
            setTimeout(checkActiveTab, 500); // Delay to let page fully load
            
            // Clear dismissed state for testing (remove this line in production)
            localStorage.removeItem('askTabNotificationDismissed');
            
          } catch (error) {
            console.error('Notification script error:', error);
          }
        }
        
        // Multiple initialization points to ensure it runs
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initNotification);
        } else {
          initNotification();
        }
        
        // Backup initialization
        setTimeout(initNotification, 1000);
        
      })();
    </script>
    <script> // Check if we can see any session cookies
      console.log('üîç Checking session state...');
      console.log('All cookies:', document.cookie);

      // Check if session cookie exists
      const hasSessionCookie = document.cookie.includes('connect.sid') || 
                              document.cookie.includes('session');
      console.log('Has session cookie:', hasSessionCookie);

      // Try to get current user with more debugging
      async function debugAuth() {
        try {
          console.log('üîç Testing /api/current-user...');
          const response = await fetch('/api/current-user', {
            credentials: 'include',  // Important: include cookies
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          console.log('Response status:', response.status);
          console.log('Response headers:', Object.fromEntries(response.headers.entries()));
          
          if (response.ok) {
            const userData = await response.json();
            console.log('‚úÖ User authenticated:', userData);
          } else if (response.status === 401) {
            console.log('‚ùå User not authenticated (401)');
          } else if (response.status === 302) {
            console.log('‚ùå Redirected to login (302)');
          } else {
            console.log('‚ùå Unexpected status:', response.status);
            const text = await response.text();
            console.log('Response body:', text);
          }
        } catch (error) {
          console.error('‚ùå Auth debug error:', error);
        }
      }

      // Run the debug
      debugAuth();
    </script>
    {{!-- <script> // make the stat boxes clickable
    document.addEventListener('DOMContentLoaded', function() {
        // Make in-range stat box clickable
        const inRangeStatBox = document.querySelector('#inRangeCount').closest('.lab-stat-box');
        const outOfRangeStatBox = document.querySelector('#outOfRangeCount').closest('.lab-stat-box');
        
        if (inRangeStatBox) {
            inRangeStatBox.style.cursor = 'pointer';
            inRangeStatBox.addEventListener('click', function() {
                window.location.href = '/reports?filter=in-range';
            });
        }
        
        if (outOfRangeStatBox) {
            outOfRangeStatBox.style.cursor = 'pointer';
            outOfRangeStatBox.addEventListener('click', function() {
                window.location.href = '/reports?filter=out-of-range';
            });
        }
    });
    </script> --}}
    <script> // 
        document.addEventListener('DOMContentLoaded', function() {
          console.log('üé® Initializing Chart.js Labs Summary...');
          
          // Get data from hidden element (DYNAMIC - reads from your backend)
          const dataElement = document.getElementById('labSummaryData');
          if (!dataElement) {
            console.error('‚ùå labSummaryData element not found');
            return;
          }

          let labData;
          try {
            labData = JSON.parse(dataElement.getAttribute('data-labs'));
            console.log('‚úÖ Loaded lab data:', labData);
          } catch (e) {
            console.error('‚ùå Error parsing lab data:', e);
            labData = { inRange: 0, improving: 0, outOfRange: 0, declining: 0 };
          }

          // Create canvas for chart
          const root = document.getElementById('labs-summary-recharts-root');
          if (!root) {
            console.error('‚ùå Root element not found');
            return;
          }

          // Check if all values are zero
          const isEmpty = labData.inRange === 0 && labData.improving === 0 && 
                          labData.outOfRange === 0 && labData.declining === 0;

          // Build the UI dynamically
          root.innerHTML = `
            <div style="width: 100%; padding: 0;">
              <!-- Stats Container -->
              <div style="display: flex; align-items: flex-end; justify-content: space-between; gap: 0.5rem; margin-bottom: 0; padding: 0 2.5rem;">
                <div class="stat-box" data-category="inRange" id="inRangeStatBox" style="flex: 1; text-align: center; padding: 0.75rem 0.15rem; cursor: pointer; border-radius: 8px; transition: all 0.2s ease;">
                  <div style="font-family: 'Poppins-Bold', sans-serif; font-size: 2rem; margin-bottom: 0.5rem; color: ${labData.inRange === 0 ? '#d76f6f' : '#7db17f'}; line-height: 1;">
                    ${labData.inRange || 0}
                  </div>
                  <div style="font-family: 'Poppins-Regular', sans-serif; font-size: 0.75rem; color: #666; white-space: nowrap;">
                    In Range
                  </div>
                </div>
                <div class="stat-box" data-category="improving" id="improvingStatBox" style="flex: 1; text-align: center; padding: 0.75rem 0.15rem; cursor: pointer; border-radius: 8px; transition: all 0.2s ease;">
                  <div style="font-family: 'Poppins-Bold', sans-serif; font-size: 2rem; margin-bottom: 0.5rem; color: ${labData.improving === 0 ? '#d76f6f' : '#9ed3a0'}; line-height: 1;">
                    ${labData.improving || 0}
                  </div>
                  <div style="font-family: 'Poppins-Regular', sans-serif; font-size: 0.75rem; color: #666; white-space: nowrap;">
                    Improving
                  </div>
                </div>
                <div class="stat-box" data-category="outOfRange" id="outOfRangeStatBox" style="flex: 1; text-align: center; padding: 0.75rem 0.15rem; cursor: pointer; border-radius: 8px; transition: all 0.2s ease;">
                  <div style="font-family: 'Poppins-Bold', sans-serif; font-size: 2rem; margin-bottom: 0.5rem; color: ${labData.outOfRange === 0 ? '#d76f6f' : '#d76f6f'}; line-height: 1;">
                    ${labData.outOfRange || 0}
                  </div>
                  <div style="font-family: 'Poppins-Regular', sans-serif; font-size: 0.75rem; color: #666; white-space: nowrap;">
                    Out of Range
                  </div>
                </div>
                <div class="stat-box" data-category="declining" id="decliningStatBox" style="flex: 1; text-align: center; padding: 0.75rem 0.15rem; cursor: pointer; border-radius: 8px; transition: all 0.2s ease;">
                  <div style="font-family: 'Poppins-Bold', sans-serif; font-size: 2rem; margin-bottom: 0.5rem; color: ${labData.declining === 0 ? '#d76f6f' : '#e98b8b'}; line-height: 1;">
                    ${labData.declining || 0}
                  </div>
                  <div style="font-family: 'Poppins-Regular', sans-serif; font-size: 0.75rem; color: #666; white-space: nowrap;">
                    Declining
                  </div>
                </div>
              </div>

              <!-- Chart -->
              <div class="labs-chart-wrapper">
                <canvas id="labsChart"></canvas>
              </div>

              ${isEmpty ? '<div style="text-align: center; padding: 1rem; color: #999; font-size: 0.9rem; font-style: italic;">Upload lab results to see your biomarker data</div>' : ''}

              <!-- Action Button (Centered) -->
              <div style="text-align: center;">
                <a href="/reports?tab=all&filter=all" 
                  style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background-color: #f5f5f5; color: #666; text-decoration: none; border-radius: 8px; font-family: 'Poppins-Medium', sans-serif; font-size: 0.9rem; transition: all 0.3s ease; margin-top: 1rem;"
                  onmouseenter="this.style.backgroundColor='#e0e0e0'; this.style.transform='translateX(4px)';"
                  onmouseleave="this.style.backgroundColor='#f5f5f5'; this.style.transform='translateX(0)';">
                  View all <span style="font-size: 1.1rem;">‚Üí</span>
                </a>
              </div>
            </div>
          `;

          // Add hover effects to stat boxes
          document.querySelectorAll('.stat-box').forEach(box => {
            box.addEventListener('mouseenter', function() {
              this.style.backgroundColor = 'rgba(0, 0, 0, 0.04)';
              this.style.transform = 'translateY(-2px)';
              this.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
            });
            box.addEventListener('mouseleave', function() {
              this.style.backgroundColor = 'transparent';
              this.style.transform = 'translateY(0)';
              this.style.boxShadow = 'none';
            });
          });

          // Make stat boxes clickable - navigate to filtered reports
          document.getElementById('inRangeStatBox')?.addEventListener('click', function() {
            window.location.href = '/reports?filter=in-range';
          });
          
          document.getElementById('outOfRangeStatBox')?.addEventListener('click', function() {
            window.location.href = '/reports?filter=out-of-range';
          });

          // Create Chart.js chart
          const ctx = document.getElementById('labsChart');
          if (!ctx || typeof Chart === 'undefined') {
            console.error('‚ùå Chart.js not loaded or canvas not found');
            return;
          }

          // Dynamic Y-axis scaling (same as original version)
          const maxValue = Math.max(labData.inRange, labData.improving, labData.outOfRange, labData.declining);
          const yAxisMax = maxValue === 0 ? 10 : Math.ceil(maxValue * 1.2);

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['In Range', 'Improving', 'Out of Range', 'Declining'],
              datasets: [{
                label: 'Biomarkers',
                data: [labData.inRange, labData.improving, labData.outOfRange, labData.declining],
                backgroundColor: [
                  labData.inRange === 0 ? '#dbdbdb' : '#7db17f',
                  labData.improving === 0 ? '#dbdbdb' : '#9ed3a0',
                  labData.outOfRange === 0 ? '#dbdbdb' : '#d76f6f',
                  labData.declining === 0 ? '#dbdbdb' : '#e98b8b'
                ],
                borderRadius: {
                  topLeft: 5,
                  topRight: 5,
                  bottomLeft: 0,
                  bottomRight: 0
                },
                borderSkipped: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'white',
                  titleColor: '#333',
                  bodyColor: '#666',
                  borderColor: '#e2e8f0',
                  borderWidth: 1,
                  padding: 12,
                  displayColors: false,
                  titleFont: {
                    size: 14,
                    weight: '600'
                  },
                  bodyFont: {
                    size: 13,
                    weight: '700'
                  },
                  callbacks: {
                    label: function(context) {
                      return context.parsed.y + ' biomarkers';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: yAxisMax,
                  ticks: { 
                    color: '#666', 
                    font: { size: 12 }
                  },
                  grid: { 
                    color: '#f0f0f0', 
                    drawBorder: false 
                  },
                  title: {
                    display: true,
                    text: 'Biomarkers',
                    color: '#666',
                    font: { size: 12 }
                  }
                },
                x: {
                  ticks: { 
                    color: '#666', 
                    font: { size: 12 }
                  },
                  grid: { display: false },
                  border: { color: '#e0e0e0' }
                }
              },
              animation: {
                duration: 800,
                easing: 'easeOutQuart'
              }
            }
          });

          console.log('‚úÖ Chart.js Labs Summary initialized successfully!');
        });
    </script>
  </body>
</html>
